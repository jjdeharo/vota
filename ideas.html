<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Ideas en Tiempo Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --theme-color-primary: #4f46e5; /* Indigo por defecto */
            --theme-color-text: #ffffff;
            --theme-color-content-bg: #f0f5ff;
            --theme-color-primary-border: #a5b4fc;
            --theme-color-primary-dark-text: #3730a3;
        }
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--theme-color-primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #qrcode-container { background: white; border-radius: 8px; padding: 1rem; display: inline-flex; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        /* Estilos para la lista de ideas */
        #ideas-list-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-content: flex-start;
            overflow-y: auto;
            height: 100%;
        }
        .idea-card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            position: relative;
            transition: all 0.3s ease;
            flex-basis: 100%; /* Ocupa todo el ancho disponible */
            border: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-width: 0; /* Ayuda a que flexbox maneje bien el desbordamiento de texto */
        }
        .idea-card p {
            flex-grow: 1;
            word-wrap: break-word; /* Rompe la palabra para evitar desbordamiento */
            overflow-wrap: break-word;
            min-width: 0;
        }
        .idea-card.has-votes {
            border-left: 5px solid var(--theme-color-primary);
        }
        .vote-count {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--theme-color-primary-dark-text);
            margin-left: 1rem;
        }
        .delete-btn {
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            margin-left: 1rem;
            padding: 0.25rem;
            border-radius: 99px;
            line-height: 1;
        }
        .delete-btn:hover {
            color: #ef4444;
            background-color: #fee2e2;
        }

        /* Themed styles */
        .themed-bg { background-color: var(--theme-color-primary); color: var(--theme-color-text); }
        .themed-bg-hover:hover { filter: brightness(90%); transition: filter 0.2s; }
        .themed-content-bg { background-color: var(--theme-color-content-bg); }
        #session-code {
            font-family: monospace; font-size: 2.25rem; font-weight: bold;
            letter-spacing: 0.1em; padding: 0.5rem 1rem;
            border: 2px dashed var(--theme-color-primary-border);
            border-radius: 0.5rem; color: var(--theme-color-primary-dark-text);
            background-color: #fff; cursor: pointer; transition: background-color 0.2s;
        }
        #session-code:hover { background-color: #f9fafb; }

        /* Projection Mode */
        body.projection-mode { overflow: hidden; cursor: pointer; }
        body.projection-mode #app { max-width: 100%; width: 100%; height: 100vh; border-radius: 0; padding: 1rem; margin: 0 !important; }
        body.projection-mode .hide-on-projection { display: none !important; }
        body.projection-mode #results-column { height: 100%; }
        body.projection-mode #results-view { height: 100%; display: flex; flex-direction: column; }
        body.projection-mode #results-question { text-align: center; font-size: 2.5rem; }
        body.projection-mode #ideas-list-container { flex-grow: 1; }
        body.projection-mode .delete-btn { display: none; }

        /* FIX: Reglas para el ancho completo en modo proyección */
        body.projection-mode #results-view .grid {
          grid-template-columns: 1fr !important;
        }
        body.projection-mode #results-column {
          grid-column: 1 / -1 !important;
        }
        body.projection-mode #results-view {
          padding: 0.5rem !important;
          border-radius: 0 !important;
        }

        /* Botón de idea votada por el participante */
        .voted-idea {
          background-color: color-mix(in srgb, var(--theme-color-primary) 15%, white);
          border-color: var(--theme-color-primary);
        }

        /* Insignia con el nº de votos que ha dado a esa idea */
        .voted-badge {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          min-width: 1.5rem;
          height: 1.5rem;
          border-radius: 9999px;
          font-size: 0.75rem;
          font-weight: 700;
          background-color: var(--theme-color-primary);
          color: var(--theme-color-text);
          margin-left: 0.75rem;
          padding: 0 0.4rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-start min-h-screen p-4 gap-6">

    <div id="app" class="w-full max-w-5xl mx-auto transition-all duration-300 relative my-auto">
        <div id="lang-selector-container" class="absolute top-4 right-4 z-10">
            <select id="lang-selector" onchange="setLanguage(this.value)" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2">
                <option value="es">Español</option>
                <option value="ca">Català</option>
                <option value="gl">Galego</option>
                <option value="eu">Euskara</option>
                <option value="en">English</option>
            </select>
        </div>

        <div id="presenter-view" class="hidden h-full">
            <div id="create-session-form" class="themed-content-bg p-6 md:p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6" data-translate-key="create_title">Crear una nueva lista de ideas</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label for="question" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="question_label">Título o pregunta:</label>
                        <input type="text" id="question" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" data-translate-key-placeholder="question_placeholder" placeholder="Ej: Ideas para mejorar el patio">
                    </div>
                     <div>
                        <label for="color-picker" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="theme_color_label">Color del tema:</label>
                        <input type="color" id="color-picker" value="#4f46e5" class="w-12 h-12 p-1 border border-gray-300 rounded-md cursor-pointer">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="ideas-per-person" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="ideas_per_person_label">Ideas por persona:</label>
                        <input type="number" id="ideas-per-person" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="votes-per-person" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="votes_per_person_label">Votos por persona:</label>
                        <input type="number" id="votes-per-person" value="3" min="1" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <button onclick="hostSession()" id="host-button" class="mt-4 w-full themed-bg themed-bg-hover font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                    <span data-translate-key="start_session_btn">Iniciar Sesión</span>
                    <div id="host-loader" class="loader hidden ml-3"></div>
                </button>
                 <p class="text-center mt-8">
                    <a href="#" onclick="event.preventDefault(); switchView('participant')" class="text-sm text-gray-500 hover:text-indigo-600" data-translate-key="switch_to_participant">¿Buscas unirte a una sesión? Haz clic aquí.</a>
                </p>
            </div>

            <div id="results-view" class="hidden themed-content-bg p-6 md:p-8 rounded-xl shadow-lg h-full">
                <div class="flex justify-between items-start gap-4 mb-4">
                    <h2 id="results-question" class="text-4xl font-extrabold flex-grow text-gray-800"></h2>
                    <div class="flex gap-2 flex-shrink-0 hide-on-projection">
                         <button id="start-voting-btn" onclick="startVotingPhase()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg" data-translate-key="start_voting_btn">Iniciar Votación</button>
                         <button id="projection-btn" onclick="toggleProjectionMode()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg" data-translate-key="projection_btn_text">Proyectar</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-full">
                    <div id="sharing-info-container" class="lg:col-span-1 space-y-6 hide-on-projection">
                         <div class="bg-white/60 p-4 rounded-lg text-center backdrop-blur-sm">
                            <h3 class="font-bold mb-2 text-gray-700" data-translate-key="scan_qr_label">1. Escanea el QR</h3>
                            <div id="qrcode-container" class="mx-auto max-w-[200px]"></div>
                        </div>
                         <div class="bg-white/60 p-4 rounded-lg text-center backdrop-blur-sm">
                             <h3 class="font-bold mb-2 text-gray-700" data-translate-key="direct_link_label">2. O comparte el enlace</h3>
                             <p id="direct-session-link" title="Haz clic para copiar" class="font-mono bg-gray-200 px-2 py-1 rounded text-sm my-1 break-all hover:bg-gray-300 inline-block max-w-full cursor-pointer truncate" onclick="copyText('direct-session-link', 'link_copied_toast')"></p>
                        </div>
                        <div class="bg-white/60 p-4 rounded-lg text-center backdrop-blur-sm">
                            <h3 class="font-bold mb-2 text-gray-700">3. <span data-translate-key="or_go_to">O ve a</span></h3>
                            <p id="app-url" title="Haz clic para copiar" class="font-mono text-sm my-1 break-all hover:text-gray-900 inline-block max-w-full cursor-pointer hover:bg-gray-200 p-1 rounded" onclick="copyText('app-url', 'url_copied_toast')"></p>
                            <p class="text-gray-600 text-sm my-2" data-translate-key="and_enter_code">e introduce el código:</p>
                            <div class="mt-2">
                                <span id="session-code" onclick="copyCode()"></span>
                            </div>
                        </div>
                    </div>
                    <div id="results-column" class="lg:col-span-2 bg-white/60 rounded-lg p-4 min-h-[400px]">
                        <div id="ideas-list-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="participant-view" class="hidden">
            <div id="join-session-form" class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4" data-translate-key="join_title">Unirse a una sesión</h2>
                <label for="code-input" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="session_code_label">Código de la sesión:</label>
                <input type="text" id="code-input" class="w-full p-2 border uppercase border-gray-300 rounded-md" data-translate-key-placeholder="code_input_placeholder" placeholder="Introduce el código">
                <button onclick="joinSession()" id="join-button" class="mt-4 w-full themed-bg themed-bg-hover font-bold py-3 px-4 rounded-lg">
                    <span data-translate-key="join_btn">Unirse</span>
                </button>
                 <p class="text-center mt-8">
                    <a href="#" onclick="event.preventDefault(); switchView('presenter')" class="text-sm text-gray-500 hover:text-indigo-600" data-translate-key="switch_to_presenter">¿Eres el presentador? Inicia sesión aquí.</a>
                </p>
            </div>

            <div id="idea-form" class="hidden bg-white p-8 rounded-xl shadow-lg">
                <h2 id="idea-form-title" class="text-2xl font-bold mb-4"></h2>
                <p id="ideas-left" class="text-sm font-medium text-gray-500 mb-2"></p>
                <textarea id="idea-input" class="w-full p-2 border border-gray-300 rounded-md" maxlength="200" data-translate-key-placeholder="idea_input_placeholder" placeholder="Escribe tu idea (máx. 200 caracteres)"></textarea>
                <button id="send-idea-btn" onclick="sendIdea()" class="mt-2 themed-bg themed-bg-hover font-bold py-2 px-4 rounded-lg" data-translate-key="send_btn">Enviar Idea</button>
                 <p id="participant-info" class="mt-4 text-green-600"></p>
            </div>

            <div id="voting-form" class="hidden bg-white p-8 rounded-xl shadow-lg">
                <h2 id="voting-form-title" class="text-2xl font-bold mb-4" data-translate-key="voting_form_title">Vota por tus ideas favoritas</h2>
                <p id="votes-left" class="text-sm font-medium text-gray-500 mb-4"></p>
                <div id="ideas-to-vote-container" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
            
            <div id="completed-view" class="hidden text-center py-8">
                 <h2 class="text-2xl font-bold mt-4" data-translate-key="completed_title">¡Gracias por participar!</h2>
                 <p class="text-gray-600" data-translate-key="completed_subtitle">Puedes ver los resultados en la pantalla principal.</p>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>

    <script>
        // --- i18n & Config ---
        const translations = {
            'es': { 'create_title': 'Crear una nueva lista de ideas', 'question_label': 'Título o pregunta:', 'question_placeholder': 'Ej: Ideas para mejorar el patio', 'theme_color_label': 'Color del tema:', 'ideas_per_person_label': 'Ideas por persona:', 'votes_per_person_label': 'Votos por persona:', 'start_session_btn': 'Iniciar Sesión', 'switch_to_participant': '¿Buscas unirte a una sesión? Haz clic aquí.', 'start_voting_btn': 'Iniciar Votación', 'projection_btn_text': 'Proyectar', 'scan_qr_label': '1. Escanea el QR', 'direct_link_label': '2. O comparte el enlace', 'or_go_to': 'O ve a', 'and_enter_code': 'e introduce el código:', 'join_title': 'Unirse a una sesión', 'session_code_label': 'Código de la sesión:', 'code_input_placeholder': 'Introduce el código', 'join_btn': 'Unirse', 'switch_to_presenter': '¿Eres el presentador? Inicia sesión aquí.', 'idea_input_placeholder': 'Escribe tu idea (máx. 200 caracteres)', 'send_btn': 'Enviar Idea', 'voting_form_title': 'Vota por tus ideas favoritas', 'completed_title': '¡Gracias por participar!', 'completed_subtitle': 'Puedes ver los resultados en la pantalla principal.', 'copied_toast': 'Código copiado', 'link_copied_toast': 'Enlace copiado', 'url_copied_toast': 'URL copiada', 'ideas_left_text': 'Te quedan {count} idea(s) por enviar.', 'votes_left_text': 'Puedes votar por {count} idea(s).', 'idea_sent_confirmation': '¡Idea enviada!', 'waiting_for_voting': 'Has enviado todas tus ideas. Esperando que el presentador inicie la votación...' },
            'ca': { 'create_title': 'Crear una nova llista d\'idees', 'question_label': 'Títol o pregunta:', 'question_placeholder': 'Ex: Idees per millorar el pati', 'theme_color_label': 'Color del tema:', 'ideas_per_person_label': 'Idees per persona:', 'votes_per_person_label': 'Vots per persona:', 'start_session_btn': 'Iniciar Sessió', 'switch_to_participant': 'Busques unir-te a una sessió? Fes clic aquí.', 'start_voting_btn': 'Iniciar Votació', 'projection_btn_text': 'Projectar', 'scan_qr_label': '1. Escaneja el QR', 'direct_link_label': '2. O comparteix l\'enllaç', 'or_go_to': 'O ves a', 'and_enter_code': 'i introdueix el codi:', 'join_title': 'Unir-se a una sessió', 'session_code_label': 'Codi de la sessió:', 'code_input_placeholder': 'Introdueix el codi', 'join_btn': 'Unir-se', 'switch_to_presenter': 'Ets el presentador? Inicia sessió aquí.', 'idea_input_placeholder': 'Escriu la teva idea (màx. 200 caràcters)', 'send_btn': 'Enviar Idea', 'voting_form_title': 'Vota per les teves idees preferides', 'completed_title': 'Gràcies per participar!', 'completed_subtitle': 'Pots veure els resultats a la pantalla principal.', 'copied_toast': 'Codi copiat', 'link_copied_toast': 'Enllaç copiat', 'url_copied_toast': 'URL copiada', 'ideas_left_text': 'Et queden {count} idea(es) per enviar.', 'votes_left_text': 'Pots votar per {count} idea(es).', 'idea_sent_confirmation': 'Idea enviada!', 'waiting_for_voting': 'Has enviat totes les teves idees. Esperant que el presentador iniciï la votació...' },
            'gl': { 'create_title': 'Crear unha nova lista de ideas', 'question_label': 'Título ou pregunta:', 'question_placeholder': 'Ex: Ideas para mellorar o patio', 'theme_color_label': 'Cor do tema:', 'ideas_per_person_label': 'Ideas por persoa:', 'votes_per_person_label': 'Votos por persoa:', 'start_session_btn': 'Iniciar Sesión', 'switch_to_participant': 'Buscas unirte a unha sesión? Fai clic aquí.', 'start_voting_btn': 'Iniciar Votación', 'projection_btn_text': 'Proxectar', 'scan_qr_label': '1. Escanea o QR', 'direct_link_label': '2. Ou comparte a ligazón', 'or_go_to': 'Ou vai a', 'and_enter_code': 'e introduce o código:', 'join_title': 'Unirse a unha sesión', 'session_code_label': 'Código da sesión:', 'code_input_placeholder': 'Introduce o código', 'join_btn': 'Unirse', 'switch_to_presenter': 'Es o presentador? Inicia sesión aquí.', 'idea_input_placeholder': 'Escribe a túa idea (máx. 200 caracteres)', 'send_btn': 'Enviar Idea', 'voting_form_title': 'Vota polas túas ideas favoritas', 'completed_title': 'Grazas por participar!', 'completed_subtitle': 'Podes ver os resultados na pantalla principal.', 'copied_toast': 'Código copiado', 'link_copied_toast': 'Ligazón copiada', 'url_copied_toast': 'URL copiada', 'ideas_left_text': 'Quédanche {count} idea(s) por enviar.', 'votes_left_text': 'Podes votar por {count} idea(s).', 'idea_sent_confirmation': 'Idea enviada!', 'waiting_for_voting': 'Enviaches todas as túas ideas. Agardando a que o presentador inicie a votación...' },
            'eu': { 'create_title': 'Ideia zerrenda berria sortu', 'question_label': 'Izenburua edo galdera:', 'question_placeholder': 'Adib: Jolastokia hobetzeko ideiak', 'theme_color_label': 'Gaiaren kolorea:', 'ideas_per_person_label': 'Ideiak pertsonako:', 'votes_per_person_label': 'Botoak pertsonako:', 'start_session_btn': 'Saioa Hasi', 'switch_to_participant': 'Saio batean sartu nahi duzu? Egin klik hemen.', 'start_voting_btn': 'Bozketa Hasi', 'projection_btn_text': 'Proiektatu', 'scan_qr_label': '1. Eskaneatu QR-a', 'direct_link_label': '2. Edo partekatu esteka', 'or_go_to': 'Edo joan hona', 'and_enter_code': 'eta sartu kodea:', 'join_title': 'Saio batean sartu', 'session_code_label': 'Saioaren kodea:', 'code_input_placeholder': 'Sartu kodea', 'join_btn': 'Sartu', 'switch_to_presenter': 'Aurkezlea zara? Hasi saioa hemen.', 'idea_input_placeholder': 'Idatzi zure ideia (gehienez 200 karaktere)', 'send_btn': 'Ideia Bidali', 'voting_form_title': 'Bozkatu zure ideia gogokoenak', 'completed_title': 'Eskerrik asko parte hartzeagatik!', 'completed_subtitle': 'Emaitzak pantaila nagusian ikus ditzakezu.', 'copied_toast': 'Kodea kopiatu da', 'link_copied_toast': 'Esteka kopiatu da', 'url_copied_toast': 'URLa kopiatu da', 'ideas_left_text': '{count} ideia geratzen zaizkizu bidaltzeko.', 'votes_left_text': '{count} ideia bozka ditzakezu.', 'idea_sent_confirmation': 'Ideia bidali da!', 'waiting_for_voting': 'Zure ideia guztiak bidali dituzu. Aurkezleak bozketa hasteko zain...' },
            'en': { 'create_title': 'Create a new idea list', 'question_label': 'Title or question:', 'question_placeholder': 'E.g., Ideas to improve the schoolyard', 'theme_color_label': 'Theme color:', 'ideas_per_person_label': 'Ideas per person:', 'votes_per_person_label': 'Votes per person:', 'start_session_btn': 'Start Session', 'switch_to_participant': 'Looking to join a session? Click here.', 'start_voting_btn': 'Start Voting', 'projection_btn_text': 'Project', 'scan_qr_label': '1. Scan the QR', 'direct_link_label': '2. Or share the link', 'or_go_to': 'Or go to', 'and_enter_code': 'and enter the code:', 'join_title': 'Join a session', 'session_code_label': 'Session code:', 'code_input_placeholder': 'Enter the code', 'join_btn': 'Join', 'switch_to_presenter': 'Are you the presenter? Log in here.', 'idea_input_placeholder': 'Write your idea (max 200 chars)', 'send_btn': 'Send Idea', 'voting_form_title': 'Vote for your favorite ideas', 'completed_title': 'Thanks for participating!', 'completed_subtitle': 'You can see the results on the main screen.', 'copied_toast': 'Code copied', 'link_copied_toast': 'Link copied', 'url_copied_toast': 'URL copied', 'ideas_left_text': 'You have {count} idea(s) left to send.', 'votes_left_text': 'You can vote for {count} idea(s).', 'idea_sent_confirmation': 'Idea sent!', 'waiting_for_voting': 'You have sent all your ideas. Waiting for the presenter to start the voting...' }
        };
        let currentLang = 'es';

        // --- Global Variables ---
        let peer = null;
        let hostConnection = null;
        let guestConnections = [];
        let sessionData = {
            question: '',
            ideasPerPerson: 1,
            votesPerPerson: 3,
            themeColor: '#4f46e5',
            ideas: [], // { id, text, votes }
            phase: 'submission' // 'submission' or 'voting'
        };
        let participantState = { submittedIdeas: 0, castVotes: 0, votes: {} }; // votes: { [ideaId]: count }
        let pendingVotes = {};   // { [ideaId]: 1 | -1 }
        
        // --- Storage Functions & Utils ---
        function saveVotesToStorage() {
          const sessionId = hostConnection ? hostConnection.peer : null;
          if (!sessionId) return;
          localStorage.setItem(`votes_${sessionId}`, JSON.stringify(participantState));
        }

        function loadVotesFromStorage(sessionId) {
          if (!sessionId) return;
          const data = localStorage.getItem(`votes_${sessionId}`);
          if (data) {
            try {
              const loadedState = JSON.parse(data);
              if (loadedState && typeof loadedState.votes === 'object') {
                  participantState = loadedState;
              }
            } catch (e) {
                console.error("Error loading votes from storage:", e);
                participantState = { submittedIdeas: 0, castVotes: 0, votes: {} };
            }
          }
        }

        function recomputeCastVotes() {
          participantState.castVotes = Object.values(participantState.votes)
            .reduce((a, v) => a + (v ? 1 : 0), 0);
        }

        function findIdeaButton(ideaId) {
          return document.querySelector(`#ideas-to-vote-container button[data-id="${ideaId}"]`);
        }

        function setButtonPending(btn, isPending) {
          if (!btn) return;
          if (isPending) {
            btn.classList.add('opacity-60', 'pointer-events-none');
            const badge = btn.querySelector('.voted-badge');
            if (badge) badge.style.display = 'none';
          } else {
            btn.classList.remove('opacity-60', 'pointer-events-none');
          }
        }

        function setButtonConfirmed(btn, voted) {
          if (!btn) return;
          if (voted) {
            btn.classList.add('voted-idea');
            const badge = btn.querySelector('.voted-badge');
            if (badge) {
              badge.textContent = 1;
              badge.style.display = 'inline-flex';
            }
          } else {
            btn.classList.remove('voted-idea');
            const badge = btn.querySelector('.voted-badge');
            if (badge) badge.style.display = 'none';
          }
        }

        // --- UI Logic ---
        function setLanguage(lang) {
            if (!translations[lang]) return;
            currentLang = lang;
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                if (translations[lang][key]) el.innerText = translations[lang][key];
            });
            document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-key-placeholder');
                if (translations[lang][key]) el.placeholder = translations[lang][key];
            });
        }
        function switchView(view) {
            document.getElementById('presenter-view').classList.add('hidden');
            document.getElementById('participant-view').classList.add('hidden');
            const appEl = document.getElementById('app');
            if (view === 'presenter') {
                document.getElementById('presenter-view').classList.remove('hidden');
                appEl.classList.add('max-w-5xl');
                appEl.classList.remove('max-w-2xl');
            } else {
                document.getElementById('participant-view').classList.remove('hidden');
                appEl.classList.remove('max-w-5xl');
                appEl.classList.add('max-w-2xl');
            }
        }
        function applyTheme(color) {
            const root = document.documentElement;
            root.style.setProperty('--theme-color-primary', color);
            const r = parseInt(color.slice(1, 3), 16), g = parseInt(color.slice(3, 5), 16), b = parseInt(color.slice(5, 7), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            const textColor = (yiq >= 128) ? '#000000' : '#ffffff';
            root.style.setProperty('--theme-color-text', textColor);
            root.style.setProperty('--theme-color-content-bg', color + '1A');
            root.style.setProperty('--theme-color-primary-border', color + '80');
            root.style.setProperty('--theme-color-primary-dark-text', `color-mix(in srgb, ${color} 70%, black)`);
        }
        function showToast(messageKey) {
            const toast = document.getElementById('toast');
            toast.innerText = (translations[currentLang] && translations[currentLang][messageKey]) || messageKey;
            toast.style.opacity = 1;
            setTimeout(() => { toast.style.opacity = 0; }, 2000);
        }

        // --- Presenter Logic ---
        function hostSession() {
            sessionData.question = document.getElementById('question').value.trim();
            if (!sessionData.question) { alert('Por favor, introduce un título.'); return; }
            
            sessionData.ideasPerPerson = parseInt(document.getElementById('ideas-per-person').value, 10);
            sessionData.votesPerPerson = parseInt(document.getElementById('votes-per-person').value, 10);
            sessionData.themeColor = document.getElementById('color-picker').value;
            applyTheme(sessionData.themeColor);

            const sessionId = Math.random().toString(36).substring(2, 8).toUpperCase();
            peer = new Peer(sessionId);

            peer.on('open', id => {
                document.getElementById('create-session-form').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('lang-selector-container').classList.add('hidden');
                
                const baseUrl = window.location.href.split('?')[0];
                const sessionUrl = `${baseUrl}?session=${id}`;
                
                document.getElementById('session-code').innerText = id;
                document.getElementById('direct-session-link').innerText = sessionUrl;
                document.getElementById('app-url').innerText = baseUrl.replace(/^https?:\/\//, '');
                document.getElementById('results-question').innerText = sessionData.question;
                
                new QRCode(document.getElementById('qrcode-container'), { text: sessionUrl, width: 160, height: 160 });
                updateIdeasListView();
            });

            peer.on('connection', conn => {
                guestConnections.push(conn);
                conn.on('open', () => conn.send({ type: 'session-data', payload: sessionData }));
                conn.on('data', data => handleGuestData(conn, data));
                conn.on('close', () => { guestConnections = guestConnections.filter(c => c.peer !== conn.peer); });
            });
        }
        
        function handleGuestData(conn, data) {
            if (data.type === 'new-idea') {
                const newIdea = { id: 'idea-' + Date.now() + Math.random(), text: data.payload, votes: 0 };
                sessionData.ideas.push(newIdea);
            } else if (data.type === 'vote') {
                const { ideaId, delta } = data.payload;
                const idea = sessionData.ideas.find(i => i.id === ideaId);
                if (idea) {
                    idea.votes += delta;
                    conn.send({ type: 'vote-confirm', payload: { ideaId, delta } });
                }
            }
            broadcastUpdate();
        }

        function updateIdeasListView() {
            const container = document.getElementById('ideas-list-container');
            container.innerHTML = '';
            const sortedIdeas = [...sessionData.ideas].sort((a, b) => b.votes - a.votes);
            
            sortedIdeas.forEach(idea => {
                const card = document.createElement('div');
                card.className = 'idea-card';
                if (idea.votes !== 0) card.classList.add('has-votes');
                
                let content = `<p>${idea.text}</p>`;
                
                const controls = document.createElement('div');
                controls.className = 'flex items-center';

                if (sessionData.phase === 'voting') {
                    const voteCount = document.createElement('div');
                    voteCount.className = 'vote-count';
                    voteCount.innerText = idea.votes;
                    controls.appendChild(voteCount);
                }

                if (sessionData.phase === 'submission') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5m-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5M4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06m3.5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06m3.5-.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06"/></svg>`;
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteIdea(idea.id);
                    };
                    controls.appendChild(deleteBtn);
                }
                
                card.innerHTML = content;
                card.appendChild(controls);
                container.appendChild(card);
            });
        }

        function deleteIdea(ideaId) {
            const ideaIndex = sessionData.ideas.findIndex(i => i.id === ideaId);
            if (ideaIndex > -1) {
                sessionData.ideas.splice(ideaIndex, 1);
                broadcastUpdate();
            }
        }

        function startVotingPhase() {
            sessionData.phase = 'voting';
            document.getElementById('start-voting-btn').style.display = 'none';
            broadcastUpdate();
        }
        
        function broadcastUpdate() {
            updateIdeasListView();
            guestConnections.forEach(conn =>
                conn.send({ type: 'session-data', payload: sessionData })
            );
        }

        // --- Participant Logic ---
        function joinSession() {
            const hostId = document.getElementById('code-input').value.trim().toUpperCase();
            if (!hostId) return;
            loadVotesFromStorage(hostId); // Load state before connecting
            peer = new Peer();
            peer.on('open', () => {
                hostConnection = peer.connect(hostId, { reliable: true });
                hostConnection.on('data', data => {
                    if (data.type === 'session-data') {
                        sessionData = data.payload;
                        applyTheme(sessionData.themeColor);
                        updateParticipantView();
                    } else if (data.type === 'vote-confirm') {
                        const { ideaId, delta } = data.payload;

                        delete pendingVotes[ideaId];

                        participantState.votes[ideaId] = delta === 1 ? 1 : 0;
                        recomputeCastVotes();
                        saveVotesToStorage();

                        const btn = findIdeaButton(ideaId);
                        setButtonPending(btn, false);
                        setButtonConfirmed(btn, participantState.votes[ideaId] === 1);

                        const votesLeft = sessionData.votesPerPerson - participantState.castVotes;
                        const votesLeftEl = document.getElementById('votes-left');
                        if (votesLeftEl) {
                          votesLeftEl.innerText = translations[currentLang]['votes_left_text'].replace('{count}', votesLeft);
                        }

                        if (participantState.castVotes >= sessionData.votesPerPerson &&
                            sessionData.ideas.some(idea => participantState.votes[idea.id])) {
                          document.getElementById('completed-view').classList.remove('hidden');
                          document.getElementById('voting-form').classList.add('hidden');
                        }
                    }
                });
            });
        }

        function updateParticipantView() {
            document.getElementById('join-session-form').classList.add('hidden');
            document.getElementById('idea-form').classList.add('hidden');
            document.getElementById('voting-form').classList.add('hidden');
            document.getElementById('completed-view').classList.add('hidden');

            if (sessionData.phase === 'submission') {
                if (participantState.submittedIdeas < sessionData.ideasPerPerson) {
                    document.getElementById('idea-form').classList.remove('hidden');
                    document.getElementById('idea-form-title').innerText = sessionData.question;
                    const ideasLeft = sessionData.ideasPerPerson - participantState.submittedIdeas;
                    document.getElementById('ideas-left').innerText = translations[currentLang]['ideas_left_text'].replace('{count}', ideasLeft);
                    document.getElementById('participant-info').innerText = '';
                } else {
                    document.getElementById('idea-form').classList.remove('hidden');
                    document.getElementById('idea-form-title').innerText = sessionData.question;
                    document.getElementById('ideas-left').innerText = '';
                    document.getElementById('idea-input').style.display = 'none';
                    document.getElementById('send-idea-btn').style.display = 'none';
                    document.getElementById('participant-info').innerText = translations[currentLang]['waiting_for_voting'];
                }
            } else if (sessionData.phase === 'voting') {
                if (participantState.castVotes >= sessionData.votesPerPerson && sessionData.ideas.some(idea => participantState.votes[idea.id])) {
                    document.getElementById('completed-view').classList.remove('hidden');
                    return;
                }

                document.getElementById('voting-form').classList.remove('hidden');
                document.getElementById('voting-form-title').innerText = sessionData.question;
                const votesLeft = sessionData.votesPerPerson - participantState.castVotes;
                document.getElementById('votes-left').innerText = translations[currentLang]['votes_left_text'].replace('{count}', votesLeft);
                
                const container = document.getElementById('ideas-to-vote-container');
                container.innerHTML = '';
                sessionData.ideas.forEach(idea => {
                  const button = document.createElement('button');
                  button.className = 'w-full p-3 border rounded-lg hover:bg-gray-100 flex items-center justify-between text-left';
                  button.dataset.id = idea.id;
                  button.innerHTML = `
                    <span class="truncate mr-3">${idea.text}</span>
                    <span class="voted-badge" style="display:none"></span>
                  `;
                  
                  const confirmedCount = participantState.votes[idea.id] || 0;
                  if (confirmedCount > 0) {
                    setButtonConfirmed(button, true);
                  }
                  if (pendingVotes[idea.id]) {
                    setButtonPending(button, true);
                  }

                  button.onclick = () => castVote(idea.id, button);
                  container.appendChild(button);
                });
            }
        }

        function sendIdea() {
            const ideaText = document.getElementById('idea-input').value.trim();
            if (!ideaText) return;
            hostConnection.send({ type: 'new-idea', payload: ideaText });
            participantState.submittedIdeas++;
            saveVotesToStorage();
            document.getElementById('idea-input').value = '';
            document.getElementById('participant-info').innerText = translations[currentLang]['idea_sent_confirmation'];
            setTimeout(updateParticipantView, 1500);
        }

        function castVote(ideaId, buttonEl) {
          const alreadyVoted = (participantState.votes[ideaId] || 0) === 1;
          const pending = pendingVotes[ideaId] || 0;

          if (pending !== 0) return;

          const delta = alreadyVoted ? -1 : 1;

          if (delta === 1 && participantState.castVotes >= sessionData.votesPerPerson) {
            return;
          }

          pendingVotes[ideaId] = delta;
          setButtonPending(buttonEl, true);

          hostConnection.send({ type: 'vote', payload: { ideaId, delta } });
        }
        
        // --- Init & Helpers ---
        function handleExitProjection(event) {
            if (event.key === 'Escape' || (event.type === 'click' && event.target.tagName !== 'BUTTON' && !event.target.closest('button'))) {
                if (document.body.classList.contains('projection-mode')) {
                    toggleProjectionMode();
                }
            }
        }

        function toggleProjectionMode() {
            const isEntering = !document.body.classList.contains('projection-mode');
            document.body.classList.toggle('projection-mode');

            if (isEntering) {
                window.addEventListener('keydown', handleExitProjection);
                document.getElementById('app').addEventListener('click', handleExitProjection);
            } else {
                window.removeEventListener('keydown', handleExitProjection);
                document.getElementById('app').removeEventListener('click', handleExitProjection);
            }
        }

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session');
            if (sessionId) {
                document.getElementById('code-input').value = sessionId;
                switchView('participant');
                joinSession();
            } else {
                switchView('participant');
            }
            setLanguage(currentLang);
            document.getElementById('color-picker').addEventListener('input', (e) => applyTheme(e.target.value));
        };
        
        function copyText(elementId, toastMessageKey) {
            navigator.clipboard.writeText(document.getElementById(elementId).innerText).then(() => showToast(toastMessageKey));
        }
        function copyCode() { copyText('session-code', 'copied_toast'); }

    </script>
</body>
</html>
