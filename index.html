<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votación en Tiempo Real con WebRTC</title>
    <!-- Tailwind CSS para un diseño rápido y moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PeerJS para la conexión WebRTC -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <!-- Librería para generar Códigos QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Google Fonts para una mejor tipografía -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bar-transition {
            transition: width 0.5s ease-in-out;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #16a34a;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #qrcode-container {
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }
        #qrcode-container img {
            display: block;
            width: 100%;
            height: auto;
        }
        /* Estilos para el Modo Proyector */
        body.projection-mode {
            overflow: hidden;
        }
        body.projection-mode #app {
            max-width: 100%;
            width: 100%;
            height: 100vh;
            border-radius: 0;
            padding: 2rem;
            cursor: pointer;
        }
        body.projection-mode #lang-selector-container,
        body.projection-mode .info-box,
        body.projection-mode #projection-btn,
        body.projection-mode .role-switch-link {
            display: none;
        }
        body.projection-mode #results-view .results-content {
             width: 100%;
             height: 100%;
             display: flex;
             flex-direction: column;
             justify-content: center;
        }
        body.projection-mode #results-question {
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 transition-all duration-300 relative">

        <!-- Selector de Idioma -->
        <div id="lang-selector-container" class="absolute top-4 right-4 z-10">
            <select id="lang-selector" onchange="setLanguage(this.value)" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-full p-2">
                <option value="es">Español</option>
                <option value="ca">Català</option>
                <option value="gl">Galego</option>
                <option value="eu">Euskara</option>
            </select>
        </div>

        <!-- Vista del Presentador (oculta por defecto) -->
        <div id="presenter-view" class="hidden">
            <div id="create-session-form">
                <h2 class="text-2xl font-bold mb-4" data-translate-key="create_title">Crear una nueva votación</h2>
                <div class="mb-4">
                    <label for="question" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="question_label">Tu pregunta:</label>
                    <input type="text" id="question" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" data-translate-key-placeholder="question_placeholder" placeholder="Ej: ¿Cuál es la capital de Cataluña?">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="options_label">Opciones de respuesta:</label>
                    <div id="options-container" class="space-y-2">
                        <input type="text" name="option" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" data-translate-key-placeholder="option_1_placeholder" placeholder="Opción 1">
                        <input type="text" name="option" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" data-translate-key-placeholder="option_2_placeholder" placeholder="Opción 2">
                    </div>
                    <button onclick="addOption()" class="mt-2 text-sm text-green-600 hover:text-green-800" data-translate-key="add_option_btn">+ Añadir opción</button>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 mt-6">
                    <button onclick="generateShareableLink()" id="prepare-button" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition duration-300 flex items-center justify-center">
                        <span data-translate-key="prepare_session_btn">Preparar sesión</span>
                    </button>
                    <button onclick="hostSession()" id="host-button" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 flex items-center justify-center">
                        <span id="host-button-text" data-translate-key="start_session_btn">Iniciar Sesión</span>
                        <div id="host-loader" class="loader hidden ml-3"></div>
                    </button>
                </div>
                <div id="shareable-link-container" class="hidden mt-4 p-4 bg-gray-100 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate-key="shareable_link_title">Enlace de preparación listo. Cópialo y guárdalo para usarlo más tarde:</label>
                    <input type="text" id="shareable-link-input" readonly class="w-full p-2 border border-gray-300 rounded-md bg-white font-mono text-sm">
                </div>
                 <p class="text-center mt-8 role-switch-link">
                    <a href="#" onclick="event.preventDefault(); switchView('student')" class="text-sm text-gray-500 hover:text-green-600" data-translate-key="switch_to_student">¿Buscas unirte a una sesión? Haz clic aquí.</a>
                </p>
            </div>
            
            <div id="results-view" class="hidden">
                 <div class="flex flex-col lg:flex-row lg:gap-8">
                    <div class="info-box lg:w-1/2 xl:w-2/5 lg:flex-shrink-0 bg-green-50 border border-green-200 p-4 rounded-md mb-6 lg:mb-0 flex flex-col">
                        <p class="font-bold text-center mb-4 text-green-800" data-translate-key="live_session_title">¡Sesión en vivo! Comparte:</p>
                        <div class="flex flex-col items-center justify-center flex-grow gap-y-4">
                            <div class="text-center w-full">
                                <p class="text-sm" data-translate-key="scan_qr_label">Escaneando el QR</p>
                                <div id="qrcode-container" class="mt-2 w-full max-w-xs mx-auto"></div>
                            </div>
                            <div class="text-center">
                                <p class="text-sm" data-translate-key="or_go_to_label">O yendo a:</p>
                                <p id="app-url" class="font-mono bg-gray-200 px-2 py-1 rounded text-sm my-1 break-all"></p>
                                <p class="text-sm mt-2" data-translate-key="and_enter_code_label">e introduciendo el código:</p>
                                <span id="session-code" class="text-2xl font-bold bg-white px-3 py-2 mt-1 inline-block rounded-md shadow-sm cursor-pointer" onclick="copyCode()"></span>
                            </div>
                        </div>
                    </div>

                    <div class="results-content flex-grow flex flex-col">
                        <div class="flex justify-between items-start gap-4 mb-8">
                            <h2 id="results-question" class="text-3xl md:text-4xl font-extrabold flex-grow"></h2>
                            <button id="projection-btn" onclick="toggleProjectionMode()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg inline-flex items-center text-sm transition-opacity duration-300 flex-shrink-0">
                                <svg id="projection-icon-enter" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path></svg>
                                <svg id="projection-icon-exit" class="w-4 h-4 mr-2 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9V4.5M15 9h4.5M15 9l5.25-5.25M15 15v4.5M15 15h4.5M15 15l5.25 5.25"></path></svg>
                                <span data-translate-key="projection_btn_text">Proyectar</span>
                            </button>
                        </div>
                        <div id="results-container" class="space-y-6 w-full"></div>
                        <p class="text-center text-2xl md:text-3xl font-bold mt-10">
                            <span data-translate-key="total_votes_label">Votos totales</span>: <span id="total-votes">0</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista del Participante (visible por defecto) -->
        <div id="student-view">
            <div id="join-session-form">
                <h2 class="text-2xl font-bold mb-4" data-translate-key="join_title">Unirse a una votación</h2>
                <label for="code-input" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="session_code_label">Código de la sesión:</label>
                <input type="text" id="code-input" class="w-full p-2 border uppercase border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" data-translate-key-placeholder="code_input_placeholder" placeholder="Introduce el código">
                <button onclick="joinSession()" id="join-button" class="mt-4 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 flex items-center justify-center">
                    <span id="join-button-text" data-translate-key="join_btn">Unirse</span>
                    <div id="join-loader" class="loader hidden ml-3"></div>
                </button>
                <p id="join-error" class="text-red-500 text-sm mt-2 hidden"></p>
                <p class="text-center mt-8 role-switch-link">
                    <a href="#" onclick="event.preventDefault(); switchView('presenter')" class="text-sm text-gray-500 hover:text-green-600" data-translate-key="switch_to_presenter">¿Eres el presentador? Inicia sesión aquí.</a>
                </p>
            </div>

            <div id="voting-view" class="hidden">
                <h2 id="vote-question" class="text-2xl font-bold mb-6"></h2>
                <div id="vote-options-container" class="space-y-3"></div>
            </div>

            <div id="voted-view" class="hidden text-center py-8">
                 <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-2xl font-bold mt-4" data-translate-key="voted_title">¡Gracias por tu voto!</h2>
                <p class="text-gray-600" data-translate-key="voted_subtitle">Puedes ver los resultados en la pantalla principal.</p>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
    </div>

    <script>
        // --- LÓGICA DE INTERNACIONALIZACIÓN (i18n) ---
        const translations = {
            'es': {
                'page_title': 'Votación en Tiempo Real',
                'create_title': 'Crear una nueva votación',
                'question_label': 'Tu pregunta:',
                'question_placeholder': 'Ej: ¿Cuál es tu color favorito?',
                'options_label': 'Opciones de respuesta:',
                'option_1_placeholder': 'Opción 1',
                'option_2_placeholder': 'Opción 2',
                'add_option_btn': '+ Añadir opción',
                'prepare_session_btn': 'Preparar sesión',
                'start_session_btn': 'Iniciar Sesión',
                'live_session_title': '¡Sesión en vivo! Comparte:',
                'scan_qr_label': 'Escaneando el QR',
                'or_go_to_label': 'O yendo a:',
                'and_enter_code_label': 'e introduciendo el código:',
                'projection_btn_text': 'Proyectar',
                'projection_btn_exit_text': 'Salir del modo proyector',
                'total_votes_label': 'Votos totales',
                'join_title': 'Unirse a una votación',
                'session_code_label': 'Código de la sesión:',
                'code_input_placeholder': 'Introduce el código',
                'join_btn': 'Unirse',
                'voted_title': '¡Gracias por tu voto!',
                'voted_subtitle': 'Puedes ver los resultados en la pantalla principal.',
                'copied_toast': 'Código copiado al portapapeles',
                'alert_no_question': 'Por favor, introduce una pregunta y al menos dos opciones.',
                'alert_connection_error': 'Ha ocurrido un error con la conexión. Por favor, recarga la página.',
                'join_error_text': 'Error de conexión. Verifica el código o que la persona anfitriona esté conectada.',
                'shareable_link_title': 'Enlace de preparación listo. Cópialo y guárdalo para usarlo más tarde:',
                'switch_to_presenter': '¿Eres el presentador? Inicia sesión aquí.',
                'switch_to_student': '¿Buscas unirte a una sesión? Haz clic aquí.',
            },
            'ca': {
                'page_title': 'Votació en Temps Real',
                'create_title': 'Crear una nova votació',
                'question_label': 'La teva pregunta:',
                'question_placeholder': 'Ex: Quin és el teu color preferit?',
                'options_label': 'Opcions de resposta:',
                'option_1_placeholder': 'Opció 1',
                'option_2_placeholder': 'Opció 2',
                'add_option_btn': '+ Afegir opció',
                'prepare_session_btn': 'Preparar sessió',
                'start_session_btn': 'Iniciar Sessió',
                'live_session_title': 'Sessió en viu! Comparteix:',
                'scan_qr_label': 'Escanejant el QR',
                'or_go_to_label': 'O anant a:',
                'and_enter_code_label': 'i introduint el codi:',
                'projection_btn_text': 'Projectar',
                'projection_btn_exit_text': 'Sortir del mode projector',
                'total_votes_label': 'Vots totals',
                'join_title': 'Unir-se a una votació',
                'session_code_label': 'Codi de la sessió:',
                'code_input_placeholder': 'Introdueix el codi',
                'join_btn': 'Unir-se',
                'voted_title': 'Gràcies pel teu vot!',
                'voted_subtitle': 'Pots veure els resultats a la pantalla principal.',
                'copied_toast': 'Codi copiat al porta-retalls',
                'alert_no_question': 'Si us plau, introdueix una pregunta i almenys dues opcions.',
                'alert_connection_error': 'Hi ha hagut un error amb la connexió. Si us plau, recarrega la pàgina.',
                'join_error_text': 'Error de connexió. Verifica el codi o que la persona amfitriona estigui connectada.',
                'shareable_link_title': 'Enllaç de preparació a punt. Copia\'l i desa\'l per a més tard:',
                'switch_to_presenter': 'Ets el presentador? Inicia sessió aquí.',
                'switch_to_student': 'Busques unir-te a una sessió? Fes clic aquí.',
            },
            'gl': {
                'page_title': 'Votación en Tempo Real',
                'create_title': 'Crear unha nova votación',
                'question_label': 'A túa pregunta:',
                'question_placeholder': 'Ex: Cal é a túa cor favorita?',
                'options_label': 'Opcións de resposta:',
                'option_1_placeholder': 'Opción 1',
                'option_2_placeholder': 'Opción 2',
                'add_option_btn': '+ Engadir opción',
                'prepare_session_btn': 'Preparar sesión',
                'start_session_btn': 'Iniciar Sesión',
                'live_session_title': 'Sesión en vivo! Comparte:',
                'scan_qr_label': 'Escaneando o QR',
                'or_go_to_label': 'Ou indo a:',
                'and_enter_code_label': 'e introducindo o código:',
                'projection_btn_text': 'Proxectar',
                'projection_btn_exit_text': 'Saír do modo proxector',
                'total_votes_label': 'Votos totais',
                'join_title': 'Unirse a unha votación',
                'session_code_label': 'Código da sesión:',
                'code_input_placeholder': 'Introduce o código',
                'join_btn': 'Unirse',
                'voted_title': 'Grazas polo teu voto!',
                'voted_subtitle': 'Podes ver os resultados na pantalla principal.',
                'copied_toast': 'Código copiado ao portapapeis',
                'alert_no_question': 'Por favor, introduce unha pregunta e polo menos dúas opcións.',
                'alert_connection_error': 'Houbo un erro coa conexión. Por favor, recarga a páxina.',
                'join_error_text': 'Erro de conexión. Verifica o código ou que a persoa anfitrioa estea conectada.',
                'shareable_link_title': 'Ligazón de preparación lista. Cópiaa e gárdaa para usala máis tarde:',
                'switch_to_presenter': 'Es o presentador? Inicia sesión aquí.',
                'switch_to_student': 'Buscas unirte a unha sesión? Fai clic aquí.',
            },
            'eu': {
                'page_title': 'Bozketa Denbora Errealean',
                'create_title': 'Bozketa berria sortu',
                'question_label': 'Zure galdera:',
                'question_placeholder': 'Adib: Zein da zure kolorerik gogokoena?',
                'options_label': 'Erantzun-aukerak:',
                'option_1_placeholder': '1. aukera',
                'option_2_placeholder': '2. aukera',
                'add_option_btn': '+ Gehitu aukera',
                'prepare_session_btn': 'Saioa prestatu',
                'start_session_btn': 'Saioa Hasi',
                'live_session_title': 'Saioa zuzenean! Partekatu:',
                'scan_qr_label': 'QR-a eskaneatzen',
                'or_go_to_label': 'Edo hona joanda:',
                'and_enter_code_label': 'eta kodea sartuz:',
                'projection_btn_text': 'Proiektatu',
                'projection_btn_exit_text': 'Proiektagailu modutik irten',
                'total_votes_label': 'Botoak guztira',
                'join_title': 'Bozketa batean sartu',
                'session_code_label': 'Saioaren kodea:',
                'code_input_placeholder': 'Sartu kodea',
                'join_btn': 'Sartu',
                'voted_title': 'Eskerrik asko zure botoagatik!',
                'voted_subtitle': 'Emaitzak pantaila nagusian ikus ditzakezu.',
                'copied_toast': 'Kodea arbelean kopiatu da',
                'alert_no_question': 'Mesedez, sartu galdera bat eta gutxienez bi aukera.',
                'alert_connection_error': 'Konexioarekin errore bat gertatu da. Mesedez, birkargatu orria.',
                'join_error_text': 'Konexio-errorea. Egiaztatu kodea edo antolatzailea konektatuta dagoela.',
                'shareable_link_title': 'Prestatzeko esteka prest. Kopiatu eta gorde geroago erabiltzeko:',
                'switch_to_presenter': 'Aurkezlea zara? Hasi saioa hemen.',
                'switch_to_student': 'Saio batean sartu nahi duzu? Egin klik hemen.',
            }
        };

        let currentLang = 'es';

        function setLanguage(lang) {
            if (!translations[lang]) return;
            currentLang = lang;
            localStorage.setItem('preferred_language', lang);
            document.documentElement.lang = lang;
            document.getElementById('lang-selector').value = lang;

            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                if (translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });
             document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-key-placeholder');
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
            document.title = translations[lang]['page_title'] || 'Votación en Tiempo Real';
        }

        // --- LÓGICA DE INICIO ---
        window.onload = function() {
            const savedLang = localStorage.getItem('preferred_language');
            const browserLang = navigator.language.split('-')[0];
            
            if (savedLang && translations[savedLang]) {
                setLanguage(savedLang);
            } else if (translations[browserLang]) {
                setLanguage(browserLang);
            } else {
                setLanguage('es');
            }

            checkURLParameters();
        };

        function checkURLParameters() {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session');
            const data = params.get('data');

            if (sessionId) { // Si hay un ID de sesión, el usuario es un participante.
                switchView('student');
                document.getElementById('code-input').value = sessionId;
                joinSession();
            } else if (data) { // Si hay datos, es una sesión preparada para un presentador.
                switchView('presenter');
                try {
                    const decodedData = JSON.parse(atob(data));
                    const questionInput = document.getElementById('question');
                    const optionsContainer = document.getElementById('options-container');
                    
                    questionInput.value = decodedData.question;
                    
                    optionsContainer.innerHTML = '';
                    decodedData.options.forEach(optionText => {
                        const newOptionInput = document.createElement('input');
                        newOptionInput.type = 'text';
                        newOptionInput.name = 'option';
                        newOptionInput.className = 'w-full p-2 border border-gray-300 rounded-md shadow-sm';
                        newOptionInput.value = optionText;
                        optionsContainer.appendChild(newOptionInput);
                    });
                } catch (e) {
                    console.error("Error al decodificar los datos de la sesión preparada:", e);
                    switchView('student'); // Si falla, volver a la vista de estudiante.
                }
            } else {
                // Por defecto, mostrar siempre la vista de estudiante.
                switchView('student');
            }
        }

        // --- Variables Globales ---
        let peer = null;
        let hostConnection = null;
        let guestConnections = [];
        let sessionData = {};
        let myPeerId = null;

        // --- LÓGICA GENERAL DE LA UI ---

        function switchView(view) {
            const presenterView = document.getElementById('presenter-view');
            const studentView = document.getElementById('student-view');
            const appContainer = document.getElementById('app');

            if (view === 'presenter') {
                presenterView.classList.remove('hidden');
                studentView.classList.add('hidden');
                appContainer.classList.remove('max-w-2xl');
                appContainer.classList.add('max-w-5xl');
            } else {
                presenterView.classList.add('hidden');
                studentView.classList.remove('hidden');
                appContainer.classList.add('max-w-2xl');
                appContainer.classList.remove('max-w-5xl');
            }
        };

        function addOption() {
            const container = document.getElementById('options-container');
            const optionCount = container.children.length + 1;
            const newOptionInput = document.createElement('input');
            newOptionInput.type = 'text';
            newOptionInput.name = 'option';
            newOptionInput.className = 'w-full p-2 border border-gray-300 rounded-md shadow-sm';
            newOptionInput.placeholder = `${translations[currentLang]['option_1_placeholder'].replace('1', optionCount)}`;
            container.appendChild(newOptionInput);
        };
        
        function copyCode() {
            const code = document.getElementById('session-code').innerText;
            navigator.clipboard.writeText(code).then(() => {
                const toast = document.getElementById('toast');
                toast.innerText = translations[currentLang]['copied_toast'];
                toast.style.opacity = 1;
                setTimeout(() => { toast.style.opacity = 0; }, 2000);
            });
        }

        function generateQRCode(url) {
            const container = document.getElementById('qrcode-container');
            container.innerHTML = '';
            new QRCode(container, {
                text: url,
                width: 220,
                height: 220,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        function toggleProjectionMode() {
            const isEntering = !document.body.classList.contains('projection-mode');
            document.body.classList.toggle('projection-mode');
            
            const btn = document.getElementById('projection-btn');
            const btnText = btn.querySelector('span');
            
            document.getElementById('projection-icon-enter').classList.toggle('hidden');
            document.getElementById('projection-icon-exit').classList.toggle('hidden');

            if (isEntering) {
                btnText.innerText = translations[currentLang]['projection_btn_exit_text'];
                window.addEventListener('keydown', handleExitProjection);
                document.getElementById('app').addEventListener('click', handleExitProjection);
            } else {
                btnText.innerText = translations[currentLang]['projection_btn_text'];
                window.removeEventListener('keydown', handleExitProjection);
                document.getElementById('app').removeEventListener('click', handleExitProjection);
            }
        }

        function handleExitProjection(event) {
            if (event.type === 'click' && event.target.closest('#projection-btn')) {
                return;
            }
            if (event.type === 'keydown' && event.key !== 'Escape') {
                return;
            }
            if (document.body.classList.contains('projection-mode')) {
                toggleProjectionMode();
            }
        }

        // --- LÓGICA DEL PRESENTADOR (ANFITRIÓN) ---
        
        function generateShareableLink() {
            const question = document.getElementById('question').value.trim();
            const optionInputs = document.querySelectorAll('#options-container input[name="option"]');
            const options = Array.from(optionInputs)
                .map(input => input.value.trim())
                .filter(text => text !== '');

            if (!question || options.length < 2) {
                alert(translations[currentLang]['alert_no_question']);
                return;
            }

            const pollData = { question, options };
            const encodedData = btoa(JSON.stringify(pollData));
            const shareUrl = window.location.href.split('?')[0] + '?data=' + encodedData;
            
            const linkContainer = document.getElementById('shareable-link-container');
            const linkInput = document.getElementById('shareable-link-input');
            linkInput.value = shareUrl;
            linkContainer.classList.remove('hidden');
            linkInput.select();
            document.execCommand('copy');
            
            const toast = document.getElementById('toast');
            toast.innerText = translations[currentLang]['copied_toast'].replace('Código', 'Enlace');
            toast.style.opacity = 1;
            setTimeout(() => { toast.style.opacity = 0; }, 2000);
        }

        function hostSession() {
            const question = document.getElementById('question').value.trim();
            const optionInputs = document.querySelectorAll('#options-container input[name="option"]');
            const options = Array.from(optionInputs)
                .map(input => input.value.trim())
                .filter(text => text !== '')
                .map(text => ({ text: text, votes: 0 }));

            if (!question || options.length < 2) {
                alert(translations[currentLang]['alert_no_question']);
                return;
            }
            
            document.getElementById('host-button-text').classList.add('hidden');
            document.getElementById('host-loader').classList.remove('hidden');
            document.getElementById('prepare-button').setAttribute('disabled', true);

            sessionData = { question, options };
            
            const sessionId = Math.random().toString(36).substring(2, 8).toUpperCase();
            peer = new Peer(sessionId); 

            peer.on('open', (id) => {
                myPeerId = id;
                const baseUrl = window.location.href.split('?')[0];
                const sessionUrl = baseUrl + '?session=' + id;
                
                generateQRCode(sessionUrl);
                document.getElementById('session-code').innerText = id;
                document.getElementById('app-url').innerText = baseUrl;

                document.getElementById('create-session-form').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                updateResultsView(sessionData);
            });

            peer.on('connection', (conn) => {
                guestConnections.push(conn);
                conn.on('open', () => {
                    conn.send({ type: 'session-data', payload: sessionData });
                });
                conn.on('data', (data) => {
                    if (data.type === 'vote') {
                        handleVote(data.payload.optionIndex);
                    }
                });
            });

             peer.on('error', (err) => {
                alert(translations[currentLang]['alert_connection_error']);
                console.error(err);
                document.getElementById('host-button-text').classList.remove('hidden');
                document.getElementById('host-loader').classList.add('hidden');
                document.getElementById('prepare-button').removeAttribute('disabled');
            });
        }

        function handleVote(optionIndex) {
            sessionData.options[optionIndex].votes++;
            broadcastUpdate();
            updateResultsView(sessionData);
        }

        function broadcastUpdate() {
            guestConnections.forEach(conn => {
                if (conn && conn.open) {
                    conn.send({ type: 'update', payload: sessionData });
                }
            });
        }

        function updateResultsView(data) {
            document.getElementById('results-question').innerText = data.question;
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = '';

            const totalVotes = data.options.reduce((sum, option) => sum + option.votes, 0);
            document.getElementById('total-votes').innerText = totalVotes;

            data.options.forEach(option => {
                const percentage = totalVotes > 0 ? (option.votes / totalVotes) * 100 : 0;
                const resultElement = document.createElement('div');
                resultElement.innerHTML = `
                    <div class="flex justify-between items-baseline mb-2">
                        <span class="text-xl md:text-2xl text-gray-800 font-medium">${option.text}</span>
                        <span class="text-xl md:text-2xl font-bold text-gray-900">${option.votes} <span class="text-lg md:text-xl text-gray-600 font-medium">(${percentage.toFixed(0)}%)</span></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-8 md:h-10">
                        <div class="bg-green-500 h-8 md:h-10 rounded-full bar-transition" style="width: ${percentage}%"></div>
                    </div>
                `;
                resultsContainer.appendChild(resultElement);
            });
        }

        // --- LÓGICA DEL PARTICIPANTE (INVITADO) ---

        function joinSession() {
            const hostId = document.getElementById('code-input').value.trim().toUpperCase();
            if (!hostId) return;
            document.getElementById('code-input').value = hostId;

            document.getElementById('join-button').setAttribute('disabled', true);
            document.getElementById('join-button-text').classList.add('hidden');
            document.getElementById('join-loader').classList.remove('hidden');
            document.getElementById('join-error').classList.add('hidden');

            peer = new Peer();

            peer.on('open', () => {
                hostConnection = peer.connect(hostId, { reliable: true });
                
                hostConnection.on('open', () => {});

                hostConnection.on('data', (data) => {
                    if (data.type === 'session-data') {
                        const hasVoted = localStorage.getItem('voted_in_' + hostConnection.peer);
                        if (hasVoted) {
                            showVotedView();
                        } else {
                            showVotingView(data.payload);
                        }
                    } else if (data.type === 'update') {
                        // Opcional: Podrías hacer algo con la actualización, pero la vista de "votado" ya es terminal.
                    }
                });
                 hostConnection.on('error', (err) => {
                    console.error('Error en la conexión:', err);
                    showJoinError();
                });
                 hostConnection.on('close', () => {
                    showJoinError();
                 });
            });
            
            peer.on('error', (err) => {
                console.error('Error de PeerJS:', err);
                showJoinError();
            });
        }
        
        function showJoinError() {
            const errorP = document.getElementById('join-error');
            errorP.innerText = translations[currentLang]['join_error_text'];
            errorP.classList.remove('hidden');
            document.getElementById('join-button-text').classList.remove('hidden');
            document.getElementById('join-loader').classList.add('hidden');
            document.getElementById('join-button').removeAttribute('disabled');
        }

        function showVotingView(data) {
            document.getElementById('join-session-form').classList.add('hidden');
            document.getElementById('voted-view').classList.add('hidden');
            const votingView = document.getElementById('voting-view');
            votingView.classList.remove('hidden');

            document.getElementById('vote-question').innerText = data.question;
            const optionsContainer = document.getElementById('vote-options-container');
            optionsContainer.innerHTML = '';

            data.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = "w-full text-left p-4 border border-gray-300 rounded-lg hover:bg-green-50 hover:border-green-400 transition duration-200";
                button.innerText = option.text;
                button.onclick = () => castVote(index);
                optionsContainer.appendChild(button);
            });
        }

        function showVotedView() {
            document.getElementById('join-session-form').classList.add('hidden');
            document.getElementById('voting-view').classList.add('hidden');
            document.getElementById('voted-view').classList.remove('hidden');
        }

        function castVote(optionIndex) {
            if (hostConnection) {
                const hostId = hostConnection.peer;
                localStorage.setItem('voted_in_' + hostId, 'true');
                
                hostConnection.send({ type: 'vote', payload: { optionIndex } });
                showVotedView();
            }
        }
    </script>
</body>
</html>
