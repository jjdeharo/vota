<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muro de Ideas Interactivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --theme-color-primary: #0891b2; /* Cyan por defecto */
            --theme-color-text: #ffffff;
            --theme-color-content-bg: #ecfeff;
            --theme-color-primary-border: #67e8f9;
            --theme-color-primary-dark-text: #164e63;
        }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; }
        #app { display: flex; flex-direction: column; flex-grow: 1; }
        .themed-bg { background-color: var(--theme-color-primary); color: var(--theme-color-text); }
        .themed-bg-hover:hover { filter: brightness(90%); transition: filter 0.2s; }
        .themed-content-bg { background-color: var(--theme-color-content-bg); }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--theme-color-primary);
            border-radius: 50%; width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #session-code {
            font-family: monospace; font-size: 2.25rem; font-weight: bold; letter-spacing: 0.1em;
            padding: 0.5rem 1rem; border: 2px dashed var(--theme-color-primary-border);
            border-radius: 0.5rem; color: var(--theme-color-primary-dark-text);
            background-color: #fff; cursor: pointer; transition: background-color 0.2s;
        }
        #session-code:hover { background-color: #f9fafb; }

        /* Contenedor de las tarjetas (Canvas) */
        #card-canvas {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: auto; /* PERMITE SCROLLBARS */
            background-image: linear-gradient(45deg, #f1f5f9 25%, transparent 25%), 
                              linear-gradient(-45deg, #f1f5f9 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #f1f5f9 75%), 
                              linear-gradient(-45deg, transparent 75%, #f1f5f9 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border-radius: 0.5rem;
            touch-action: none;
        }
        .card {
            position: absolute; display: flex; flex-direction: column;
            width: 220px; /* Ancho fijo para consistencia */
            min-height: 100px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 0.75rem;
            cursor: grab; transition: transform 0.3s ease, box-shadow 0.2s ease;
            touch-action: none; box-sizing: border-box;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .card:active { cursor: grabbing; }
        .card.interact-dragging { box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); z-index: 10; }
        
        .card-header { font-weight: 700; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(0,0,0,0.1); word-wrap: break-word; }
        .card-body { flex-grow: 1; padding-top: 0.5rem; font-size: 0.95rem; word-wrap: break-word; }
        .delete-card-btn {
            position: absolute; top: -8px; right: -8px;
            background-color: #4b5563; color: white;
            width: 24px; height: 24px; border-radius: 99px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; transition: opacity 0.2s ease;
        }
        .card:hover .delete-card-btn { opacity: 1; }

        /* Vistas y modo proyector */
        #presenter-view { flex-grow: 1; display: flex; flex-direction: column; }
        #results-view { flex-grow: 1; display: flex; flex-direction: column; padding: 1rem; }
        #results-view-grid { flex-grow: 1; display: grid; grid-template-columns: 1fr; lg:grid-template-columns: repeat(3, 1fr); gap: 1rem; min-height: 0; }
        #results-column { min-height: 0; }
        
        body.projection-mode .hide-on-projection,
        body.projection-mode footer,
        body.projection-mode #lang-selector-container { display: none !important; }
        body.projection-mode #app { padding: 0; }
        body.projection-mode #results-view { padding: 0.5rem; }
        body.projection-mode #card-canvas { border-radius: 0; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="w-full max-w-7xl mx-auto bg-white shadow-lg">
        
        <div id="lang-selector-container" class="absolute top-4 right-4 z-20">
            <select id="lang-selector" onchange="setLanguage(this.value)" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2">
                <option value="es">Español</option>
                <option value="ca">Català</option>
            </select>
        </div>

        <div id="presenter-view" class="hidden">
            <div id="create-session-form" class="themed-content-bg p-6 md:p-8 rounded-xl m-auto">
                <h2 class="text-2xl font-bold mb-6" data-translate-key="create_title">Crear un nuevo muro</h2>
                <div class="space-y-4">
                    <div>
                        <label for="question" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="question_label">Título o pregunta del muro:</label>
                        <input type="text" id="question" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" data-translate-key-placeholder="question_placeholder" placeholder="Ej: ¿Qué hemos aprendido hoy?">
                    </div>
                    <div>
                        <label for="cards-per-person" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="cards_per_person_label">Tarjetas por persona:</label>
                        <input type="number" id="cards-per-person" value="2" min="1" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <button onclick="hostSession()" id="host-button" class="mt-6 w-full themed-bg themed-bg-hover font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                    <span data-translate-key="start_session_btn">Iniciar Sesión</span>
                    <div id="host-loader" class="loader hidden ml-3"></div>
                </button>
                 <p class="text-center mt-8"><a href="#" onclick="event.preventDefault(); switchView('participant')" class="text-sm text-gray-500 hover:text-cyan-600" data-translate-key="switch_to_participant">¿Buscas unirte a un muro? Haz clic aquí.</a></p>
            </div>

            <div id="results-view" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 hide-on-projection">
                    <h2 id="results-question" class="text-2xl font-bold text-gray-800 text-center md:text-left flex-shrink-0"></h2>
                    <div class="flex gap-2 flex-wrap justify-center">
                        <button onclick="autoArrangeCards()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded-lg text-sm" data-translate-key="auto_arrange_btn">Auto-organizar</button>
                         <button onclick="exportPDF()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg text-sm" data-translate-key="export_pdf_btn">Exportar a PDF</button>
                        <button onclick="toggleProjectionMode()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-lg text-sm" data-translate-key="projection_btn_text">Proyectar</button>
                    </div>
                </div>
                <div id="results-view-grid" class="lg:grid-cols-3">
                    <div id="sharing-info-container" class="lg:col-span-1 space-y-4 hide-on-projection">
                       <div class="bg-white p-4 rounded-lg text-center border">
                           <h3 class="font-bold mb-2 text-gray-700" data-translate-key="scan_qr_label">1. Escanea el QR</h3>
                           <div id="qrcode-container" class="mx-auto max-w-[160px] bg-white p-2 rounded-lg"></div>
                       </div>
                        <div class="bg-white p-4 rounded-lg text-center border">
                            <h3 class="font-bold mb-2 text-gray-700" data-translate-key="direct_link_label">2. O comparte el enlace</h3>
                            <p id="direct-session-link" class="font-mono bg-gray-100 px-2 py-1 rounded text-sm break-all"></p>
                       </div>
                       <div class="bg-white p-4 rounded-lg text-center border">
                           <h3 class="font-bold mb-2 text-gray-700">3. <span data-translate-key="or_go_to">O ve a</span></h3>
                           <p id="app-url" class="font-mono text-sm break-all"></p>
                           <p class="text-gray-600 text-sm my-1" data-translate-key="and_enter_code">e introduce el código:</p>
                           <span id="session-code"></span>
                       </div>
                    </div>
                    <div id="results-column" class="lg:col-span-2 bg-gray-200 rounded-lg">
                        <div id="card-canvas"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="participant-view" class="hidden m-auto">
            <div id="join-session-form" class="bg-white p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4" data-translate-key="join_title">Unirse a un muro</h2>
                <label for="code-input" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="session_code_label">Código del muro:</label>
                <input type="text" id="code-input" class="w-full p-2 border uppercase border-gray-300 rounded-md">
                <button onclick="joinSession()" class="mt-4 w-full themed-bg themed-bg-hover font-bold py-3 px-4 rounded-lg">
                    <span data-translate-key="join_btn">Unirse</span>
                </button>
                 <p class="text-center mt-8"><a href="#" onclick="event.preventDefault(); switchView('presenter')" class="text-sm text-gray-500 hover:text-cyan-600" data-translate-key="switch_to_presenter">¿Eres el presentador? Crea un muro aquí.</a></p>
            </div>

            <div id="card-form" class="hidden bg-white p-8 rounded-xl">
                <h2 id="card-form-title" class="text-2xl font-bold mb-4"></h2>
                <p id="cards-left" class="text-sm font-medium text-gray-500 mb-4"></p>
                <div class="space-y-4">
                     <div>
                        <label for="card-title" class="block text-sm font-medium text-gray-700" data-translate-key="card_title_label">Título</label>
                        <input type="text" id="card-title" maxlength="50" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="card-body" class="block text-sm font-medium text-gray-700" data-translate-key="card_body_label">Contenido</label>
                        <textarea id="card-body" rows="3" maxlength="300" class="mt-1 w-full p-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div>
                        <label for="card-color" class="block text-sm font-medium text-gray-700" data-translate-key="card_color_label">Color</label>
                        <input type="color" id="card-color" value="#fef08a" class="mt-1 w-16 h-10 p-1 border border-gray-300 rounded-md cursor-pointer">
                    </div>
                </div>
                <button id="send-card-btn" onclick="sendCard()" class="mt-6 w-full themed-bg themed-bg-hover font-bold py-2 px-4 rounded-lg" data-translate-key="send_btn">Enviar Tarjeta</button>
                <p id="participant-info" class="mt-4 text-green-600"></p>
            </div>
            
            <div id="completed-view" class="hidden text-center py-8">
                 <h2 class="text-2xl font-bold mt-4" data-translate-key="completed_title">¡Gracias por participar!</h2>
                 <p class="text-gray-600" data-translate-key="completed_subtitle">Has enviado todas tus tarjetas.</p>
            </div>
        </div>
    </div>
    
    <footer class="text-center py-2 text-sm text-gray-500 bg-gray-100 hide-on-projection">
        Aplicación creada por <a href="https://bilateria.org" target="_blank" class="underline hover:text-gray-700">Juan José de Haro</a>
    </footer>

    <script>
        const { jsPDF } = window.jspdf;
        const translations = {
            'es': { 'create_title': 'Crear un nuevo muro de ideas', 'question_label': 'Título o pregunta del muro:', 'question_placeholder': 'Ej: ¿Qué hemos aprendido hoy?', 'cards_per_person_label': 'Tarjetas por persona:', 'start_session_btn': 'Iniciar Sesión', 'switch_to_participant': '¿Buscas unirte a un muro? Haz clic aquí.', 'auto_arrange_btn': 'Auto-organizar', 'export_pdf_btn': 'Exportar a PDF', 'projection_btn_text': 'Proyectar', 'scan_qr_label': '1. Escanea el QR', 'direct_link_label': '2. O comparte el enlace', 'or_go_to': 'O ve a', 'and_enter_code': 'e introduce el código:', 'join_title': 'Unirse a un muro', 'session_code_label': 'Código del muro:', 'join_btn': 'Unirse', 'switch_to_presenter': '¿Eres el presentador? Crea un muro aquí.', 'card_title_label': 'Título', 'card_body_label': 'Contenido', 'card_color_label': 'Color de la tarjeta', 'send_btn': 'Enviar Tarjeta', 'completed_title': '¡Gracias por participar!', 'completed_subtitle': 'Has enviado todas tus tarjetas.', 'cards_left_text': 'Puedes enviar {count} tarjeta(s) más.', 'card_sent_confirmation': '¡Tarjeta enviada!', 'alert_no_title_or_body': 'Por favor, escribe un título y un contenido para la tarjeta.', 'pdf_export_error': 'Error al exportar a PDF.' },
            'ca': { 'create_title': 'Crear un nou mur d\'idees', 'question_label': 'Títol o pregunta del mur:', 'question_placeholder': 'Ex: Què hem après avui?', 'cards_per_person_label': 'Targetes per persona:', 'start_session_btn': 'Iniciar Sessió', 'switch_to_participant': 'Busques unir-te a un mur? Fes clic aquí.', 'auto_arrange_btn': 'Autoorganitzar', 'export_pdf_btn': 'Exportar a PDF', 'projection_btn_text': 'Projectar', 'scan_qr_label': '1. Escaneja el QR', 'direct_link_label': '2. O comparteix l\'enllaç', 'or_go_to': 'O ves a', 'and_enter_code': 'i introdueix el codi:', 'join_title': 'Unir-se a un mur', 'session_code_label': 'Codi del mur:', 'join_btn': 'Unir-se', 'switch_to_presenter': 'Ets el presentador? Crea un mur aquí.', 'card_title_label': 'Títol', 'card_body_label': 'Contingut', 'card_color_label': 'Color de la targeta', 'send_btn': 'Enviar Targeta', 'completed_title': 'Gràcies per participar!', 'completed_subtitle': 'Has enviat totes les teves targetes.', 'cards_left_text': 'Pots enviar {count} targeta(es) més.', 'card_sent_confirmation': 'Targeta enviada!', 'alert_no_title_or_body': 'Si us plau, escriu un títol i un contingut per a la targeta.', 'pdf_export_error': 'Error en exportar a PDF.' }
        };
        let currentLang = 'es';
        let peer = null, hostConnection = null, guestConnections = [];
        let sessionData = { question: '', cardsPerPerson: 1, cards: [] };
        let participantState = { submittedCards: 0 };

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                if (translations[lang]?.[key]) el.innerText = translations[lang][key];
            });
            document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-key-placeholder');
                if (translations[lang]?.[key]) el.placeholder = translations[lang][key];
            });
        }
        function switchView(view) {
            document.getElementById('presenter-view').classList.toggle('hidden', view !== 'presenter');
            document.getElementById('participant-view').classList.toggle('hidden', view !== 'participant');
        }

        function hostSession() {
            sessionData.question = document.getElementById('question').value.trim() || 'Muro de Ideas';
            sessionData.cardsPerPerson = parseInt(document.getElementById('cards-per-person').value, 10);
            sessionData.cards = [];
            document.getElementById('host-loader').classList.remove('hidden');
            document.getElementById('host-button').setAttribute('disabled', true);
            peer = new Peer(Math.random().toString(36).substring(2, 8).toUpperCase());
            peer.on('open', id => {
                document.getElementById('create-session-form').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-question').innerText = sessionData.question;
                const baseUrl = window.location.href.split('?')[0];
                const sessionUrl = `${baseUrl}?session=${id}`;
                document.getElementById('session-code').innerText = id;
                document.getElementById('direct-session-link').innerText = sessionUrl;
                document.getElementById('app-url').innerText = baseUrl.replace(/^https?:\/\//, '');
                new QRCode(document.getElementById('qrcode-container'), { text: sessionUrl, width: 150, height: 150 });
            });
            peer.on('connection', conn => {
                guestConnections.push(conn);
                conn.on('open', () => conn.send({ type: 'session-data', payload: sessionData }));
                conn.on('data', data => handleGuestData(conn, data));
                conn.on('close', () => { guestConnections = guestConnections.filter(c => c.peer !== conn.peer); });
            });
        }
        
        function handleGuestData(conn, data) {
            if (data.type === 'new-card') {
                const canvas = document.getElementById('card-canvas');
                data.payload.position = { x: Math.random() * (canvas.offsetWidth - 220), y: Math.random() * (canvas.offsetHeight - 150) };
                sessionData.cards.push(data.payload);
            }
            broadcastUpdate();
        }

        function broadcastUpdate() {
            updatePresenterCards();
            const updatePayload = { type: 'session-update', payload: sessionData };
            guestConnections.forEach(conn => conn.send(updatePayload));
        }

        function updatePresenterCards() {
            const canvas = document.getElementById('card-canvas');
            const existingCardIds = sessionData.cards.map(c => c.id);
            
            // Remove deleted cards
            Array.from(canvas.children).forEach(cardEl => {
                if (!existingCardIds.includes(cardEl.id)) {
                    canvas.removeChild(cardEl);
                }
            });

            // Add or update cards
            sessionData.cards.forEach(cardData => {
                let cardEl = document.getElementById(cardData.id);
                if (!cardEl) {
                    cardEl = document.createElement('div');
                    cardEl.className = 'card';
                    cardEl.id = cardData.id;
                    cardEl.innerHTML = `<div class="card-header"></div><div class="card-body"></div>
                        <div class="delete-card-btn" onclick="deleteCard('${cardData.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                        </div>`;
                    canvas.appendChild(cardEl);
                }
                
                cardEl.querySelector('.card-header').innerText = cardData.title;
                cardEl.querySelector('.card-body').innerText = cardData.body;
                cardEl.style.backgroundColor = cardData.color;
                cardEl.style.transform = `translate(${cardData.position.x}px, ${cardData.position.y}px)`;
                cardEl.setAttribute('data-x', cardData.position.x);
                cardEl.setAttribute('data-y', cardData.position.y);
            });
        }

        function deleteCard(cardId) {
            sessionData.cards = sessionData.cards.filter(c => c.id !== cardId);
            broadcastUpdate();
        }

        function autoArrangeCards() {
            const canvas = document.getElementById('card-canvas');
            const padding = 16, cardWidth = 220;
            let x = padding, y = padding, maxYInRow = 0;
            sessionData.cards.forEach(cardData => {
                const cardEl = document.getElementById(cardData.id);
                if (!cardEl) return;
                
                if (x + cardWidth + padding > canvas.offsetWidth) {
                    x = padding;
                    y = maxYInRow;
                }
                cardData.position = { x, y };
                x += cardWidth + padding;
                maxYInRow = Math.max(maxYInRow, y + cardEl.offsetHeight + padding);
            });
            broadcastUpdate();
        }

        function exportPDF() {
            const canvas = document.getElementById('card-canvas');
            canvas.style.backgroundColor = 'white';
            html2canvas(canvas, { scale: 2, useCORS: true, logging: false })
                .then(cv => {
                    const imgData = cv.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: cv.width > cv.height ? 'l' : 'p', unit: 'px', format: [cv.width, cv.height] });
                    pdf.addImage(imgData, 'PNG', 0, 0, cv.width, cv.height);
                    pdf.save(`${sessionData.question.replace(/ /g, '_') || 'muro'}.pdf`);
                }).catch(err => alert(translations[currentLang].pdf_export_error))
                  .finally(() => canvas.style.backgroundColor = '');
        }

        function joinSession() {
            const hostId = document.getElementById('code-input').value.trim().toUpperCase();
            if (!hostId) return;
            peer = new Peer();
            peer.on('open', () => {
                hostConnection = peer.connect(hostId, { reliable: true });
                hostConnection.on('data', data => {
                    if (data.type === 'session-data' || data.type === 'session-update') {
                        sessionData = data.payload;
                        showCardForm();
                    }
                });
            });
        }

        function showCardForm() {
            document.getElementById('join-session-form').classList.add('hidden');
            const cardsLeft = sessionData.cardsPerPerson - participantState.submittedCards;
            if (cardsLeft > 0) {
                document.getElementById('card-form').classList.remove('hidden');
                document.getElementById('card-form-title').innerText = sessionData.question;
                document.getElementById('cards-left').innerText = translations[currentLang].cards_left_text.replace('{count}', cardsLeft);
            } else {
                document.getElementById('completed-view').classList.remove('hidden');
            }
        }

        function sendCard() {
            const title = document.getElementById('card-title').value.trim();
            const body = document.getElementById('card-body').value.trim();
            if (!title || !body) { alert(translations[currentLang].alert_no_title_or_body); return; }

            hostConnection.send({ type: 'new-card', payload: { id: 'card-' + Date.now() + Math.random(), title, body, color: document.getElementById('card-color').value } });
            
            participantState.submittedCards++;
            document.getElementById('card-title').value = '';
            document.getElementById('card-body').value = '';
            const infoEl = document.getElementById('participant-info');
            infoEl.innerText = translations[currentLang].card_sent_confirmation;
            setTimeout(() => { infoEl.innerText = ''; }, 2000);
            showCardForm();
        }
        
        function toggleProjectionMode() { document.body.classList.toggle('projection-mode'); }
        
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session');
            if (sessionId) {
                switchView('participant');
                document.getElementById('code-input').value = sessionId;
                joinSession();
            } else {
                switchView('presenter');
                // Asumir presentador por defecto si no hay session ID
                document.getElementById('presenter-view').classList.remove('hidden');
                document.getElementById('participant-view').classList.add('hidden');
            }
            setLanguage('es');

            interact('.card').draggable({
                listeners: {
                    move(event) {
                        const target = event.target;
                        let x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                        let y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                        target.style.transform = `translate(${x}px, ${y}px)`;
                        target.setAttribute('data-x', x);
                        target.setAttribute('data-y', y);
                    },
                    end(event) {
                        const card = sessionData.cards.find(c => c.id === event.target.id);
                        if (card) {
                            card.position.x = parseFloat(event.target.getAttribute('data-x')) || 0;
                            card.position.y = parseFloat(event.target.getAttribute('data-y')) || 0;
                            broadcastUpdate(); // CORRECCIÓN: Notifica a todos el cambio de posición
                        }
                    }
                }
            });
        };
    </script>
</body>
</html>
