<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nube de Palabras en Tiempo Real</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --theme-color-primary:#4f46e5;
  --theme-color-text:#ffffff;
  --theme-color-content-bg:#f0f5ff;
  --theme-color-primary-border:#a5b4fc;
  --theme-color-primary-dark-text:#3730a3;
  --footer-h:0px;
  --body-gap:24px;
}
body{font-family:'Inter',sans-serif;}
#app{
  transition:all .3s ease-in-out;
  position:relative; z-index:1;
  height:calc(100vh - var(--footer-h) - var(--body-gap));
  min-height:0;
  overflow:hidden;
  display:flex; flex-direction:column;
}
.loader{border:4px solid #f3f3f3;border-top:4px solid var(--theme-color-primary);border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.themed-bg{background-color:var(--theme-color-primary);color:var(--theme-color-text);}
.themed-bg-hover:hover{filter:brightness(90%);transition:filter .2s;}
.themed-content-bg{background-color:var(--theme-color-content-bg);}
.themed-info-box-text{color:var(--theme-color-primary-dark-text);}
#session-code{font-family:monospace;font-size:2.25rem;font-weight:bold;letter-spacing:.1em;padding:.5rem 1rem;border:2px dashed var(--theme-color-primary-border);border-radius:.5rem;color:var(--theme-color-primary-dark-text);background:#fff;cursor:pointer;transition:background-color .2s;}
#session-code:hover{background:#f9fafb;}
/* Projection */
body.projection-mode{overflow:hidden;}
body.projection-mode #app{max-width:100%;width:100%;height:100vh;border-radius:0;padding:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;background-color:var(--theme-color-content-bg);}
body.projection-mode #results-view{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0;background:transparent;}
.hide-on-projection{transition:opacity .3s ease, visibility .3s ease;}
body.projection-mode .hide-on-projection{display:none!important;}
body.projection-mode #results-question{font-size:2.5rem;text-align:center;margin:0 0 .5rem 0;flex-shrink:0;}
body.projection-mode #results-column{width:100%;max-width:100vw;flex:1 1 auto;min-height:0;padding:0;background:transparent;border-radius:0;box-shadow:none;overflow:hidden;}
body.projection-mode #results-view .grid{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:100%;width:100%;gap:0;}
/* Results sizing */
#results-view{padding:1rem!important;height:100%;min-height:480px;margin-top:0;margin-bottom:0;}
#results-view:not(.hidden){display:flex;flex-direction:column;}
#results-view:not(.hidden) > .grid{flex:1 1 auto;min-height:0;align-items:stretch;gap:1rem;}
#results-column{height:100%;min-height:0;overflow:hidden;}
#sharing-info-container{overflow:auto;max-height:100%;}
/* Participant centering */
#participant-view{min-height:100%;display:flex;flex-direction:column;justify-content:center;}
@media (max-height:640px){#participant-view{justify-content:flex-start;}}
/* Ensure Tailwind hidden works over any default display */
.hidden{display:none!important;}
</style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-start min-h-screen p-4 gap-6">

<div id="app" class="w-full max-w-5xl mx-auto rounded-xl shadow-lg transition-all duration-300 relative">

  <!-- Selector de Idioma (se oculta en vivo) -->
  <div id="lang-selector-container" class="absolute top-4 right-4 z-10 hide-on-projection">
    <select id="lang-selector" onchange="setLanguage(this.value)" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2">
      <option value="es">Español</option>
      <option value="ca">Català</option>
      <option value="gl">Galego</option>
      <option value="eu">Euskara</option>
      <option value="en">English</option>
    </select>
  </div>

  <!-- Vista del Presentador -->
  <div id="presenter-view" class="hidden">
    <div id="create-session-form" class="themed-content-bg p-6 md:p-8 rounded-xl">
      <h2 class="text-2xl font-bold mb-6" data-translate-key="create_title">Crear una nueva lluvia de ideas</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="md:col-span-2">
          <label for="question" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="question_label">Título o pregunta:</label>
          <input type="text" id="question" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" data-translate-key-placeholder="question_placeholder" placeholder="Ej: ¿Qué es para ti la biología?">
        </div>
        <div>
          <label for="word-limit" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="word_limit_label">Palabras por persona:</label>
          <input type="number" id="word-limit" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
        </div>
      </div>

      <div>
        <label for="color-picker" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="theme_color_label">Color del tema:</label>
        <input type="color" id="color-picker" value="#4f46e5" class="w-12 h-12 p-1 border border-gray-300 rounded-md cursor-pointer">
      </div>

      <div class="flex flex-col sm:flex-row gap-4 mt-6">
        <button onclick="generateShareableLink()" id="prepare-button" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition duration-300 flex items-center justify-center">
          <span data-translate-key="prepare_session_btn">Preparar sesión</span>
        </button>
        <button onclick="hostSession()" id="host-button" class="w-full themed-bg themed-bg-hover font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
          <span id="host-button-text" data-translate-key="start_session_btn">Iniciar Sesión</span>
          <div id="host-loader" class="loader hidden ml-3"></div>
        </button>
      </div>
      <div id="shareable-link-container" class="hidden mt-4 p-4 bg-gray-100 rounded-lg">
        <label class="block text-sm font-medium text-gray-700 mb-2" data-translate-key="shareable_link_title">Enlace de preparación listo. Cópialo y guárdalo:</label>
        <input type="text" id="shareable-link-input" readonly class="w-full p-2 border border-gray-300 rounded-md bg-white font-mono text-sm">
      </div>
      <p class="text-center mt-8 role-switch-link">
        <a href="#" onclick="event.preventDefault(); switchView('participant')" class="text-sm text-gray-500 hover:text-indigo-600" data-translate-key="switch_to_participant">¿Buscas unirte a una sesión? Haz clic aquí.</a>
      </p>
    </div>

    <div id="results-view" class="hidden themed-content-bg p-6 md:p-8 rounded-xl">
      <div class="flex justify-between items-start gap-4 mb-4">
        <h2 id="results-question" class="text-4xl font-extrabold flex-grow text-gray-800"></h2>
        <div class="flex gap-2 flex-shrink-0 hide-on-projection">
          <button id="projection-btn" onclick="toggleProjectionMode()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm inline-flex items-center">
            <svg id="projection-icon-enter" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path></svg>
            <svg id="projection-icon-exit" class="w-4 h-4 mr-2 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9V4.5M15 9h4.5M15 9l5.25-5.25M15 15v4.5M15 15h4.5M15 15l5.25 5.25"></path></svg>
            <span data-translate-key="projection_btn_text">Proyectar</span>
          </button>
          <button id="edit-btn" onclick="confirmEndSession()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
            <span data-translate-key="edit_btn_text">Editar</span>
          </button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div id="sharing-info-container" class="lg:col-span-1 space-y-6 hide-on-projection">
          <div class="bg-white/60 p-4 rounded-lg text-center backdrop-blur-sm">
            <h3 class="font-bold mb-2 text-gray-700" data-translate-key="scan_qr_label">1. Escanea el QR</h3>
            <div id="qrcode-container" class="mx-auto max-w-[200px]"></div>
          </div>
          <div class="bg-white/60 p-4 rounded-lg text-center backdrop-blur-sm">
            <h3 class="font-bold mb-2 text-gray-700" data-translate-key="direct_link_label">2. O comparte el enlace</h3>
            <p id="direct-session-link" title="Haz clic para copiar" class="font-mono bg-gray-200 px-2 py-1 rounded text-sm my-1 break-all hover:bg-gray-300 inline-block max-w-full cursor-pointer truncate" onclick="copyText('direct-session-link', 'url_copied_toast')"></p>
          </div>
          <div class="bg-white/60 p-4 rounded-lg text-center backdrop-blur-sm">
            <h3 class="font-bold mb-2 text-gray-700">3. <span data-translate-key="or_go_to">O ve a</span></h3>
            <p id="app-url" title="Haz clic para copiar" class="font-mono text-sm my-1 break-all hover:text-gray-900 inline-block max-w-full cursor-pointer hover:bg-gray-200 p-1 rounded" onclick="copyText('app-url', 'url_copied_toast')"></p>
            <p class="text-gray-600 text-sm my-2" data-translate-key="and_enter_code">e introduce el código:</p>
            <div class="mt-2"><span id="session-code" onclick="copyCode()"></span></div>
          </div>
          <p id="participant-count" class="text-center text-sm text-gray-600 mt-4"></p>
        </div>
        <div id="results-column" class="lg:col-span-2 bg-white/60 rounded-lg p-4 min-h-[400px]">
          <div class="flex justify-between items-center mb-4 hide-on-projection">
            <div>
              <label for="layout-selector" class="text-sm font-medium" data-translate-key="layout_label">Diseño:</label>
              <select id="layout-selector" onchange="changeLayout(this.value)" class="rounded-md border-gray-300 text-sm ml-2">
                <option value="horizontal" data-translate-key="layout_horizontal">Horizontal</option>
                <option value="mixed" data-translate-key="layout_mixed">Mixto</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button onclick="exportPNG()" class="text-sm bg-white border border-gray-300 rounded-md px-3 py-1 hover:bg-gray-100" data-translate-key="export_png_btn">Exportar PNG</button>
              <button onclick="exportCSV()" class="text-sm bg-white border border-gray-300 rounded-md px-3 py-1 hover:bg-gray-100" data-translate-key="export_csv_btn">Exportar CSV</button>
            </div>
          </div>
          <div id="wordcloud-container" class="min-h-[400px]"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista del Participante -->
  <div id="participant-view" class="hidden bg-white p-6 md:p-8 rounded-xl">
    <div id="join-session-form">
      <h2 class="text-2xl font-bold mb-4" data-translate-key="join_title">Unirse a una sesión</h2>
      <label for="code-input" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="session_code_label">Código de la sesión:</label>
      <input type="text" id="code-input" class="w-full p-2 border uppercase border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" data-translate-key-placeholder="code_input_placeholder" placeholder="Introduce el código">
      <button onclick="joinSession()" id="join-button" class="mt-4 w-full themed-bg themed-bg-hover font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
        <span id="join-button-text" data-translate-key="join_btn">Unirse</span>
        <div id="join-loader" class="loader hidden ml-3"></div>
      </button>
      <p id="join-error" class="text-red-500 text-sm mt-2 hidden"></p>
      <p class="text-center mt-8 role-switch-link">
        <a href="#" onclick="event.preventDefault(); switchView('presenter')" class="text-sm text-gray-500 hover:text-indigo-600" data-translate-key="switch_to_presenter">¿Eres el presentador? Inicia sesión aquí.</a>
      </p>
    </div>

    <div id="word-form" class="hidden">
      <h2 id="word-form-title" class="text-2xl font-bold mb-4"></h2>
      <p class="text-gray-600 mb-4" data-translate-key="word_form_instructions">Escribe una palabra o frase corta y pulsa Enviar.</p>
      <p id="words-left" class="text-sm font-medium text-gray-500 mb-2"></p>
      <div class="flex gap-2">
        <input type="text" id="word-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" data-translate-key-placeholder="word_input_placeholder" placeholder="Escribe una palabra...">
        <button id="send-word-btn" onclick="sendWord()" class="themed-bg themed-bg-hover font-bold py-2 px-4 rounded-lg transition"><span data-translate-key="send_btn">Enviar</span></button>
      </div>
      <p id="sent-confirmation" class="mt-4 text-green-600 hidden"></p>
      <p id="send-error" class="text-red-500 hidden"></p>
    </div>

    <div id="completed-view" class="hidden text-center py-8">
      <svg class="mx-auto h-16 w-16 themed-info-box-text" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h2 class="text-2xl font-bold mt-4" data-translate-key="completed_title">¡Gracias por participar!</h2>
      <p class="text-gray-600" data-translate-key="completed_subtitle">Has enviado todas tus palabras. Puedes ver los resultados en la pantalla principal.</p>
    </div>
  </div>
</div>

<div id="tooltip"></div>

<footer class="text-center py-4 text-sm text-gray-500 hide-on-projection">
  <span data-translate-key="footer_created_by">Aplicación creada por</span> <a href="https://bilateria.org" target="_blank" class="underline hover:text-gray-700">Juan José de Haro</a>
  <br>
  <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="license" class="underline hover:text-gray-700" data-translate-key="footer_license">Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional</a>
</footer>

<div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>

<div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
    <h3 class="text-lg font-bold mb-4" data-translate-key="confirm_end_title">¿Finalizar sesión?</h3>
    <p class="text-gray-600 mb-6" data-translate-key="confirm_end_text">Esto terminará la sesión actual. Deberás compartir un nuevo código para que se unan de nuevo.</p>
    <div class="flex justify-end gap-4">
      <button onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded" data-translate-key="cancel_btn">Cancelar</button>
      <button onclick="endSessionAndEdit()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded" data-translate-key="end_session_btn">Finalizar</button>
    </div>
  </div>
</div>

<script>
// i18n (igual que antes, recortado por brevedad en este snippet)
const translations = {
 'es': {'create_title':'Crear una nueva lluvia de ideas','question_label':'Título o pregunta:','question_placeholder':'Ej: ¿Qué es para ti la biología?','word_limit_label':'Palabras por persona:','theme_color_label':'Color del tema:','prepare_session_btn':'Preparar sesión','start_session_btn':'Iniciar Sesión','shareable_link_title':'Enlace de preparación listo. Cópialo y guárdalo:','switch_to_participant':'¿Buscas unirte a una sesión? Haz clic aquí.','edit_btn_text':'Editar','scan_qr_label':'1. Escanea el QR','direct_link_label':'2. O comparte el enlace','or_go_to':'O ve a','and_enter_code':'e introduce el código:','participant_count_text':'Participantes conectados: {count}','join_title':'Unirse a una sesión','session_code_label':'Código de la sesión:','code_input_placeholder':'Introduce el código','join_btn':'Unirse','switch_to_presenter':'¿Eres el presentador? Inicia sesión aquí.','word_form_instructions':'Escribe una palabra o frase corta y pulsa Enviar.','words_left_text':'Te quedan {count} palabras.','word_input_placeholder':'Escribe una palabra...','send_btn':'Enviar','sent_confirmation_text':'¡Palabra enviada!','send_timeout_error':'No se recibió respuesta. Inténtalo de nuevo.','completed_title':'¡Gracias por participar!','completed_subtitle':'Has enviado todas tus palabras. Puedes ver los resultados en la pantalla principal.','copied_toast':'Código copiado','link_copied_toast':'Enlace copiado','url_copied_toast':'URL copiada','alert_no_question':'Por favor, introduce un título.','alert_connection_error':'Error de conexión. Recarga la página.','join_error_text':'Error de conexión. Verifica el código o que el anfitrión esté conectado.','confirm_end_title':'¿Finalizar sesión?','confirm_end_text':'Esto terminará la sesión actual. Deberás compartir un nuevo código para que se unan de nuevo.','cancel_btn':'Cancelar','end_session_btn':'Finalizar','layout_label':'Diseño:','layout_mixed':'Mixto','layout_horizontal':'Horizontal','export_png_btn':'Exportar PNG','export_csv_btn':'Exportar CSV','projection_btn_text':'Proyectar','projection_btn_exit_text':'Salir del proyector','footer_created_by':'Aplicación creada por','footer_license':'Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional'},
 'en': {'create_title':'Create a new brainstorm','question_label':'Title or question:','question_placeholder':'E.g., What is biology to you?','word_limit_label':'Words per person:','theme_color_label':'Theme color:','prepare_session_btn':'Prepare session','start_session_btn':'Start Session','shareable_link_title':'Preparation link ready. Copy and save it:','switch_to_participant':'Looking to join a session? Click here.','edit_btn_text':'Edit','scan_qr_label':'1. Scan the QR','direct_link_label':'2. Or share the link','or_go_to':'Or go to','and_enter_code':'and enter the code:','participant_count_text':'Connected participants: {count}','join_title':'Join a session','session_code_label':'Session code:','code_input_placeholder':'Enter code','join_btn':'Join','switch_to_presenter':'Are you the presenter? Log in here.','word_form_instructions':'Type a word or short phrase and press Send.','words_left_text':'You have {count} words left.','word_input_placeholder':'Type a word...','send_btn':'Send','sent_confirmation_text':'Word sent!','send_timeout_error':'No response received. Please try again.','completed_title':'Thanks for participating!','completed_subtitle':'You have sent all your words. You can see the results on the main screen.','copied_toast':'Code copied','link_copied_toast':'Link copied','url_copied_toast':'URL copied','alert_no_question':'Please enter a title.','alert_connection_error':'Connection error. Please reload the page.','join_error_text':'Connection error. Check the code or that the host is connected.','confirm_end_title':'End session?','confirm_end_text':'This will end the current session. You will need to share a new code for them to join again.','cancel_btn':'Cancel','end_session_btn':'End Session','layout_label':'Layout:','layout_mixed':'Mixed','layout_horizontal':'Horizontal','export_png_btn':'Export PNG','export_csv_btn':'Export CSV','projection_btn_text':'Project','projection_btn_exit_text':'Exit projector','footer_created_by':'Application created by','footer_license':'Creative Commons Attribution-ShareAlike 4.0 International'}
};
let currentLang='es';
function setLanguage(lang){
  if(!translations[lang]) return;
  currentLang=lang;
  localStorage.setItem('preferred_language',lang);
  document.documentElement.lang=lang;
  document.getElementById('lang-selector').value=lang;
  document.querySelectorAll('[data-translate-key]').forEach(el=>{
    const key=el.getAttribute('data-translate-key');
    const tr=translations[lang][key];
    if(tr && !el.querySelector('svg')){ el.innerText=tr; }
    else if(tr){
      const textNode=Array.from(el.childNodes).find(n=>n.nodeType===Node.TEXT_NODE || n.tagName==='SPAN');
      if(textNode) textNode.textContent=tr;
    }
  });
  document.querySelectorAll('[data-translate-key-placeholder]').forEach(el=>{
    const key=el.getAttribute('data-translate-key-placeholder');
    if(translations[lang] && translations[lang][key]) el.placeholder=translations[lang][key];
  });
}
// Theme
function getContrastColor(hex){ if(hex.startsWith('#')) hex=hex.slice(1); const r=parseInt(hex.substring(0,2),16), g=parseInt(hex.substring(2,4),16), b=parseInt(hex.substring(4,6),16); const yiq=((r*299)+(g*587)+(b*114))/1000; return (yiq>=128)?'#000000':'#ffffff';}
function applyTheme(color){
  const root=document.documentElement;
  root.style.setProperty('--theme-color-primary',color);
  root.style.setProperty('--theme-color-text',getContrastColor(color));
  root.style.setProperty('--theme-color-content-bg',color+'1A');
  root.style.setProperty('--theme-color-primary-border',color+'80');
  const r=parseInt(color.substring(1,3),16),g=parseInt(color.substring(3,5),16),b=parseInt(color.substring(5,7),16);
  const darken=c=>Math.max(0,Math.floor(c*0.7)).toString(16).padStart(2,'0');
  root.style.setProperty('--theme-color-primary-dark-text',`#${darken(r)}${darken(g)}${darken(b)}`);
}

// Globals
let peer=null, hostConnection=null, guestConnections=[], wordCounts={}, sessionData={}, myWordsCount=0, sendTimeout=null, currentLayout='horizontal';
const colors=d3.scale.category10();

function ensureExclusive(view){
  const pv=document.getElementById('presenter-view');
  const tv=document.getElementById('participant-view');
  pv.classList.add('hidden'); tv.classList.add('hidden');
  if(view==='presenter'){ pv.classList.remove('hidden'); }
  else { tv.classList.remove('hidden'); }
}

function switchView(view){
  ensureExclusive(view);
  const appEl=document.getElementById('app');
  appEl.classList.toggle('max-w-5xl', view==='presenter');
  appEl.classList.toggle('max-w-2xl', view==='participant');
}

function showToast(key){ const t=document.getElementById('toast'); t.innerText=(translations[currentLang] && translations[currentLang][key])||key; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,2000);}
function copyText(id,key){ navigator.clipboard.writeText(document.getElementById(id).innerText).then(()=>showToast(key)); }
function copyCode(){ copyText('session-code','copied_toast'); }
function generateQRCode(url){ const c=document.getElementById('qrcode-container'); c.innerHTML=''; new QRCode(c,{text:url,width:200,height:200}); }
function confirmEndSession(){ document.getElementById('confirm-modal').classList.remove('hidden'); }
function closeModal(){ document.getElementById('confirm-modal').classList.add('hidden'); }

function toggleProjectionMode(){
  const entering=!document.body.classList.contains('projection-mode');
  document.body.classList.toggle('projection-mode');
  const btnText=document.querySelector('#projection-btn span');
  document.getElementById('projection-icon-enter').classList.toggle('hidden');
  document.getElementById('projection-icon-exit').classList.toggle('hidden');
  if(entering){
    btnText.innerText=translations[currentLang]['projection_btn_exit_text'];
    window.addEventListener('keydown',handleExitProjection);
    document.getElementById('app').addEventListener('click',handleExitProjection);
  }else{
    btnText.innerText=translations[currentLang]['projection_btn_text'];
    window.removeEventListener('keydown',handleExitProjection);
    document.getElementById('app').removeEventListener('click',handleExitProjection);
  }
  setTimeout(()=>{ updateFooterSpace(); drawWordCloud(); },300);
}
function handleExitProjection(e){
  if(e.target.closest && e.target.closest('#projection-btn')) return;
  if(e.type==='keydown' && e.key==='Escape'){ if(document.body.classList.contains('projection-mode')) toggleProjectionMode(); }
  else if(e.type==='click'){ if(document.body.classList.contains('projection-mode')) toggleProjectionMode(); }
}

function endSessionAndEdit(){
  guestConnections.forEach(c=>c.close());
  guestConnections=[];
  if(peer){ peer.destroy(); peer=null; }
  closeModal();
  document.getElementById('results-view').classList.add('hidden');
  document.getElementById('create-session-form').classList.remove('hidden');
  document.getElementById('lang-selector-container').classList.remove('hidden');
  document.getElementById('host-button-text').classList.remove('hidden');
  document.getElementById('host-loader').classList.add('hidden');
  document.getElementById('prepare-button').removeAttribute('disabled');
  switchView('presenter');
}

function generateShareableLink(){
  const q=document.getElementById('question').value.trim();
  if(!q){ alert(translations[currentLang]['alert_no_question']); return; }
  const poll={question:q, wordLimit:document.getElementById('word-limit').value, themeColor:document.getElementById('color-picker').value};
  const url=window.location.href.split('?')[0]+'?data='+btoa(JSON.stringify(poll));
  document.getElementById('shareable-link-input').value=url;
  document.getElementById('shareable-link-container').classList.remove('hidden');
  navigator.clipboard.writeText(url).then(()=>showToast('link_copied_toast'));
}

function hostSession(){
  const q=document.getElementById('question').value.trim();
  if(!q){ alert(translations[currentLang]['alert_no_question']); return; }
  document.getElementById('host-button-text').classList.add('hidden');
  document.getElementById('host-loader').classList.remove('hidden');
  document.getElementById('prepare-button').setAttribute('disabled',true);
  sessionData={question:q, wordLimit:document.getElementById('word-limit').value, themeColor:document.getElementById('color-picker').value};
  applyTheme(sessionData.themeColor);
  wordCounts={}; currentLayout=document.getElementById('layout-selector').value;
  const id=Math.random().toString(36).substring(2,8).toUpperCase();
  peer=new Peer(id);

  peer.on('open', (pid)=>{
    const base=window.location.href.split('?')[0];
    const sessUrl=`${base}?session=${pid}`;
    generateQRCode(sessUrl);
    document.getElementById('session-code').innerText=pid;
    document.getElementById('direct-session-link').innerText=sessUrl;
    document.getElementById('app-url').innerText=base.replace(/^https?:\/\//,'');
    document.getElementById('create-session-form').classList.add('hidden');
    document.getElementById('results-view').classList.remove('hidden');
    document.getElementById('results-question').innerText=sessionData.question;
    updateParticipantCount(); drawWordCloud();
    // Ocultar selector de idioma durante el vivo
    document.getElementById('lang-selector-container').classList.add('hidden');
    ensureExclusive('presenter');
  });

  peer.on('connection', (conn)=>{
    guestConnections.push(conn); updateParticipantCount();
    conn.on('open', ()=> conn.send({type:'session-data', payload:sessionData}));
    conn.on('data', (data)=>{
      if(data.type==='word'){ handleNewWord(data.payload); conn.send({type:'word-received'}); }
    });
    conn.on('close', ()=>{ guestConnections = guestConnections.filter(c=>c.peer!==conn.peer); updateParticipantCount(); });
  });

  peer.on('error', (err)=>{ alert(translations[currentLang]['alert_connection_error']); console.error(err); endSessionAndEdit(); });
}

function handleNewWord(w){
  const n=w.trim().toLowerCase(); if(n==="") return;
  wordCounts[n]=(wordCounts[n]||0)+1; drawWordCloud();
}
function updateParticipantCount(){ const c=guestConnections.length; const t=translations[currentLang]['participant_count_text'].replace('{count}',c); document.getElementById('participant-count').innerText=t; }

function exportPNG(){
  const node=document.getElementById('results-column');
  domtoimage.toBlob(node,{bgcolor:getComputedStyle(node).backgroundColor}).then(blob=>{ window.saveAs(blob,'nube-de-palabras.png'); });
}
function exportCSV(){
  let csv="data:text/csv;charset=utf-8,Palabra,Frecuencia\n";
  const list=Object.entries(wordCounts).sort((a,b)=>b[1]-a[1]);
  list.forEach(([w,c])=>{ csv += `"${w}",${c}\n`; });
  const uri=encodeURI(csv);
  const link=document.createElement("a");
  link.setAttribute("href",uri); link.setAttribute("download","datos_nube_de_palabras.csv");
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
}

function joinSession(){
  const hostId=document.getElementById('code-input').value.trim().toUpperCase();
  if(!hostId) return;
  document.getElementById('join-button-text').classList.add('hidden');
  document.getElementById('join-loader').classList.remove('hidden');
  document.getElementById('join-error').classList.add('hidden');
  peer=new Peer();
  peer.on('open', ()=>{
    hostConnection=peer.connect(hostId,{reliable:true});
    hostConnection.on('data',(data)=>{
      if(data.type==='session-data'){
        sessionData=data.payload; applyTheme(sessionData.themeColor);
        const key=`wordcloud_count_${hostConnection.peer}`;
        myWordsCount=parseInt(localStorage.getItem(key)||'0',10);
        showWordForm();
      }else if(data.type==='word-received'){
        clearTimeout(sendTimeout); myWordsCount++;
        const key=`wordcloud_count_${hostConnection.peer}`;
        localStorage.setItem(key,myWordsCount); updateWordsLeft();
      }
    });
    hostConnection.on('error',(e)=>{ console.error(e); showJoinError(); });
    hostConnection.on('close',()=>{ if(myWordsCount < sessionData.wordLimit) showJoinError(); });
  });
  peer.on('error',(e)=>{ console.error(e); showJoinError(); });
}
function showJoinError(){
  const je=document.getElementById('join-error');
  je.innerText=translations[currentLang]['join_error_text']; je.classList.remove('hidden');
  document.getElementById('join-button-text').classList.remove('hidden');
  document.getElementById('join-loader').classList.add('hidden');
}
function showWordForm(){
  document.getElementById('join-session-form').classList.add('hidden');
  document.getElementById('completed-view').classList.add('hidden');
  document.getElementById('word-form').classList.remove('hidden');
  document.getElementById('word-form-title').innerText=sessionData.question; updateWordsLeft();
  ensureExclusive('participant');
}
function showCompletedView(){
  document.getElementById('word-form').classList.add('hidden');
  document.getElementById('completed-view').classList.remove('hidden');
}
function updateWordsLeft(){
  const left=sessionData.wordLimit - myWordsCount;
  const leftEl=document.getElementById('words-left');
  const conf=document.getElementById('sent-confirmation');
  if(left>0){
    leftEl.innerText=translations[currentLang]['words_left_text'].replace('{count}',left);
    leftEl.classList.remove('hidden');
    document.getElementById('word-input').disabled=false;
    document.getElementById('send-word-btn').disabled=false;
    conf.innerText=translations[currentLang]['sent_confirmation_text'];
    conf.classList.remove('hidden'); setTimeout(()=>conf.classList.add('hidden'),2000);
  }else{ showCompletedView(); }
}
function sendWord(){
  if(!hostConnection) return;
  const input=document.getElementById('word-input');
  const w=input.value.trim(); if(!w) return;
  document.getElementById('send-error').classList.add('hidden');
  hostConnection.send({type:'word',payload:w}); input.value='';
  sendTimeout=setTimeout(()=>{
    const e=document.getElementById('send-error');
    e.innerText=translations[currentLang]['send_timeout_error']; e.classList.remove('hidden');
  },10000);
}

// Word cloud sizing
function getAvailableBox(){
  const inProjection=document.body.classList.contains('projection-mode');
  if(inProjection){
    const rv=document.getElementById('results-view');
    const q=document.getElementById('results-question');
    const s=getComputedStyle(rv);
    const padX=parseFloat(s.paddingLeft)+parseFloat(s.paddingRight);
    const padY=parseFloat(s.paddingTop)+parseFloat(s.paddingBottom);
    const width=rv.clientWidth - padX;
    const height=rv.clientHeight - padY - q.offsetHeight - 8;
    return {width:Math.max(0,width), height:Math.max(0,height)};
  }else{
    const parent=document.getElementById('results-column');
    const styles=getComputedStyle(parent);
    const padX=parseFloat(styles.paddingLeft)+parseFloat(styles.paddingRight);
    const padY=parseFloat(styles.paddingTop)+parseFloat(styles.paddingBottom);
    const header=parent.querySelector('.hide-on-projection');
    let headerH=0;
    if(header && header.offsetParent!==null){
      const hs=getComputedStyle(header);
      headerH=header.offsetHeight + parseFloat(hs.marginTop)+parseFloat(hs.marginBottom);
    }
    const width=parent.clientWidth - padX;
    const height=parent.clientHeight - padY - headerH;
    return {width:Math.max(0,width), height:Math.max(0,height)};
  }
}
function drawWordCloud(){
  if(Object.keys(wordCounts).length===0){ d3.select("#wordcloud-container svg").remove(); return; }
  const {width,height}=getAvailableBox();
  const list=Object.entries(wordCounts).map(([t,c])=>({text:t,count:c})).sort((a,b)=>b.count-a.count);
  const counts=list.map(d=>d.count);
  const min=d3.min(counts)||1, max=d3.max(counts)||1;
  const baseSide=Math.min(width,height);
  const maxFontBase=Math.max(48, Math.min(baseSide/2.2, 280));
  const minFontBase=Math.max(18, maxFontBase/6);
  const scale=(min===max) ? d3.scale.linear().domain([0,max]).range([minFontBase,maxFontBase])
                          : d3.scale.log().domain([min,max]).range([minFontBase,maxFontBase]);
  const withBase=list.map(d=>({text:d.text,count:d.count,baseSize:scale(d.count)}));
  function attempt(k,tries){
    const words=withBase.map(d=>({text:d.text,size:d.baseSize*k,count:d.count}));
    let placed=[];
    const layout=d3.layout.cloud().size([width,height]).words(words).padding(2)
      .rotate(()=> currentLayout==='horizontal'?0:(~~(Math.random()*2)*90))
      .fontSize(d=>d.size)
      .on("end", w=>{ placed=w; const all=placed.length===withBase.length;
        if(!all && tries>0) attempt(k*0.9, tries-1); else render(placed); });
    layout.start();
  }
  attempt(1.0,8);
  function render(words){
    d3.select("#wordcloud-container svg").remove();
    const tooltip=d3.select("#tooltip");
    const svg=d3.select("#wordcloud-container").append("svg")
      .attr("width",width).attr("height",height)
      .attr("viewBox",`0 0 ${width} ${height}`)
      .attr("preserveAspectRatio","xMidYMid meet")
      .append("g").attr("transform",`translate(${width/2},${height/2})`);
    svg.selectAll("text").data(words).enter().append("text").attr("class","word")
      .style("font-size",d=>d.size+"px").style("fill",(d,i)=>colors(i)).attr("text-anchor","middle")
      .attr("transform",d=>`translate(${[d.x,d.y]})rotate(${d.rotate})`).text(d=>d.text)
      .on("mouseover", function(d){ tooltip.style("opacity",.9); tooltip.html(`${d.text}: ${d.count}`)
        .style("left",(d3.event.pageX+5)+"px").style("top",(d3.event.pageY-28)+"px"); })
      .on("mouseout", function(){ tooltip.style("opacity",0); });
  }
}

// URL params & init
function checkURLParameters(){
  const p=new URLSearchParams(window.location.search);
  const sessionId=p.get('session');
  const data=p.get('data');
  if(sessionId){
    switchView('participant');
    document.getElementById('code-input').value=sessionId;
    joinSession();
  }else if(data){
    switchView('presenter');
    try{
      const d=JSON.parse(atob(data));
      document.getElementById('question').value=d.question||'';
      document.getElementById('word-limit').value=d.wordLimit||1;
      if(d.themeColor){ const cp=document.getElementById('color-picker'); cp.value=d.themeColor; applyTheme(cp.value); }
    }catch(e){ console.error('Error al decodificar datos',e); switchView('participant'); }
  }else{
    // SIEMPRE pantalla de participante por defecto
    switchView('participant');
  }
}

function updateFooterSpace(){
  const footer=document.querySelector('footer');
  const root=document.documentElement;
  const gap=parseFloat(getComputedStyle(document.body).rowGap || 24);
  const h=footer ? footer.offsetHeight : 0;
  root.style.setProperty('--footer-h', (h + gap) + 'px');
}

window.onload=()=>{
  // Seguridad: inicia solo con participante visible.
  ensureExclusive('participant');
  document.getElementById('results-view').classList.add('hidden');
  updateFooterSpace();
  const savedLang=localStorage.getItem('preferred_language');
  const browserLang=(navigator.language||navigator.userLanguage||'es').split('-')[0];
  setLanguage(savedLang || (translations[browserLang]?browserLang:'es'));
  checkURLParameters();

  const cp=document.getElementById('color-picker');
  if(cp) cp.addEventListener('input',e=>applyTheme(e.target.value));
  const wi=document.getElementById('word-input');
  if(wi) wi.addEventListener('keyup',e=>{ if(e.key==='Enter') sendWord(); });
  window.addEventListener('resize', ()=>{
    updateFooterSpace();
    if(document.getElementById('results-view').offsetParent!==null) drawWordCloud();
  });
};
</script>
</body>
</html>
